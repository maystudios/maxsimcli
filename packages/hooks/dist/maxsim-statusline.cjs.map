{"version":3,"file":"maxsim-statusline.cjs","names":["path","os","fs"],"sources":["../src/shared.ts","../src/maxsim-statusline.ts"],"sourcesContent":["/**\n * Shared utilities for MAXSIM hooks.\n */\n\n/**\n * Read all stdin as a string, then invoke callback with parsed JSON.\n * Used by context-monitor and statusline hooks.\n */\nexport function readStdinJson<T>(callback: (data: T) => void): void {\n  let input = '';\n  process.stdin.setEncoding('utf8');\n  process.stdin.on('data', (chunk: string) => (input += chunk));\n  process.stdin.on('end', () => {\n    try {\n      const data = JSON.parse(input) as T;\n      callback(data);\n    } catch {\n      // Silent fail -- never block hook execution\n      process.exit(0);\n    }\n  });\n}\n\n/** The '.claude' path segment -- template marker replaced during install. */\nexport const CLAUDE_DIR = '.claude';\n","#!/usr/bin/env node\n/**\n * Claude Code Statusline - MAXSIM Edition\n * Shows: model | current task | directory | context usage\n */\n\nimport * as fs from 'node:fs';\nimport * as path from 'node:path';\nimport * as os from 'node:os';\nimport { readStdinJson, CLAUDE_DIR } from './shared';\n\nexport interface StatuslineInput {\n  model?: { display_name?: string };\n  workspace?: { current_dir?: string };\n  session_id?: string;\n  context_window?: { remaining_percentage?: number };\n}\n\nexport function formatStatusline(data: StatuslineInput): string {\n  const model = data.model?.display_name || 'Claude';\n  const dir = data.workspace?.current_dir || process.cwd();\n  const session = data.session_id || '';\n  const remaining = data.context_window?.remaining_percentage;\n\n  // Context window display (shows USED percentage scaled to 80% limit)\n  let ctx = '';\n  if (remaining != null) {\n    const rem = Math.round(remaining);\n    const rawUsed = Math.max(0, Math.min(100, 100 - rem));\n    // Scale: 80% real usage = 100% displayed\n    const used = Math.min(100, Math.round((rawUsed / 80) * 100));\n\n    // Write context metrics to bridge file for the context-monitor PostToolUse hook.\n    if (session) {\n      try {\n        const bridgePath = path.join(os.tmpdir(), `claude-ctx-${session}.json`);\n        const bridgeData = JSON.stringify({\n          session_id: session,\n          remaining_percentage: remaining,\n          used_pct: used,\n          timestamp: Math.floor(Date.now() / 1000),\n        });\n        fs.writeFileSync(bridgePath, bridgeData);\n      } catch {\n        // Silent fail -- bridge is best-effort, don't break statusline\n      }\n    }\n\n    // Build progress bar (10 segments)\n    const filled = Math.floor(used / 10);\n    const bar = '\\u2588'.repeat(filled) + '\\u2591'.repeat(10 - filled);\n\n    // Color based on scaled usage\n    if (used < 63) {\n      ctx = ` \\x1b[32m${bar} ${used}%\\x1b[0m`;\n    } else if (used < 81) {\n      ctx = ` \\x1b[33m${bar} ${used}%\\x1b[0m`;\n    } else if (used < 95) {\n      ctx = ` \\x1b[38;5;208m${bar} ${used}%\\x1b[0m`;\n    } else {\n      ctx = ` \\x1b[5;31m\\uD83D\\uDC80 ${bar} ${used}%\\x1b[0m`;\n    }\n  }\n\n  // Current task from todos\n  let task = '';\n  const homeDir = os.homedir();\n  const todosDir = path.join(homeDir, CLAUDE_DIR, 'todos');\n  if (session && fs.existsSync(todosDir)) {\n    try {\n      const files = fs.readdirSync(todosDir)\n        .filter((f: string) => f.startsWith(session) && f.includes('-agent-') && f.endsWith('.json'))\n        .map((f: string) => ({ name: f, mtime: fs.statSync(path.join(todosDir, f)).mtime }))\n        .sort((a: { mtime: Date }, b: { mtime: Date }) => b.mtime.getTime() - a.mtime.getTime());\n\n      if (files.length > 0) {\n        try {\n          const todos = JSON.parse(fs.readFileSync(path.join(todosDir, files[0].name), 'utf8'));\n          const inProgress = todos.find((t: { status: string; activeForm?: string }) => t.status === 'in_progress');\n          if (inProgress) task = inProgress.activeForm || '';\n        } catch {\n          // ignore\n        }\n      }\n    } catch {\n      // Silently fail on file system errors - don't break statusline\n    }\n  }\n\n  // MAXSIM update available?\n  let maxsimUpdate = '';\n  const cacheFile = path.join(homeDir, CLAUDE_DIR, 'cache', 'maxsim-update-check.json');\n  if (fs.existsSync(cacheFile)) {\n    try {\n      const cache = JSON.parse(fs.readFileSync(cacheFile, 'utf8'));\n      if (cache.update_available) {\n        maxsimUpdate = '\\x1b[33m\\u2B06 /maxsim:update\\x1b[0m \\u2502 ';\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  // Output\n  const dirname = path.basename(dir);\n  if (task) {\n    return `${maxsimUpdate}\\x1b[2m${model}\\x1b[0m \\u2502 \\x1b[1m${task}\\x1b[0m \\u2502 \\x1b[2m${dirname}\\x1b[0m${ctx}`;\n  } else {\n    return `${maxsimUpdate}\\x1b[2m${model}\\x1b[0m \\u2502 \\x1b[2m${dirname}\\x1b[0m${ctx}`;\n  }\n}\n\n// Standalone entry\nif (require.main === module) {\n  readStdinJson<StatuslineInput>((data) => {\n    process.stdout.write(formatStatusline(data));\n  });\n}\n"],"mappings":"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"}