{"version":3,"file":"maxsim-statusline.cjs","names":["path","os","fs"],"sources":["../../../src/hooks/shared.ts","../../../src/hooks/maxsim-statusline.ts"],"sourcesContent":["/**\r\n * Shared utilities for MAXSIM hooks.\r\n */\r\n\r\n/**\r\n * Read all stdin as a string, then invoke callback with parsed JSON.\r\n * Used by context-monitor and statusline hooks.\r\n */\r\nexport function readStdinJson<T>(callback: (data: T) => void): void {\r\n  let input = '';\r\n  process.stdin.setEncoding('utf8');\r\n  process.stdin.on('data', (chunk: string) => (input += chunk));\r\n  process.stdin.on('end', () => {\r\n    try {\r\n      const data = JSON.parse(input) as T;\r\n      callback(data);\r\n    } catch {\r\n      // Silent fail -- never block hook execution\r\n      process.exit(0);\r\n    }\r\n  });\r\n}\r\n\r\n/** The '.claude' path segment -- template marker replaced during install. */\r\nexport const CLAUDE_DIR = '.claude';\r\n","#!/usr/bin/env node\r\n/**\r\n * Claude Code Statusline - MAXSIM Edition\r\n * Shows: model | current task | directory | context usage\r\n */\r\n\r\nimport * as fs from 'node:fs';\r\nimport * as path from 'node:path';\r\nimport * as os from 'node:os';\r\nimport { readStdinJson, CLAUDE_DIR } from './shared';\r\n\r\nexport interface StatuslineInput {\r\n  model?: { display_name?: string };\r\n  workspace?: { current_dir?: string };\r\n  session_id?: string;\r\n  context_window?: { remaining_percentage?: number };\r\n}\r\n\r\nexport function formatStatusline(data: StatuslineInput): string {\r\n  const model = data.model?.display_name || 'Claude';\r\n  const dir = data.workspace?.current_dir || process.cwd();\r\n  const session = data.session_id || '';\r\n  const remaining = data.context_window?.remaining_percentage;\r\n\r\n  // Context window display (shows USED percentage scaled to 80% limit)\r\n  let ctx = '';\r\n  if (remaining != null) {\r\n    const rem = Math.round(remaining);\r\n    const rawUsed = Math.max(0, Math.min(100, 100 - rem));\r\n    // Scale: 80% real usage = 100% displayed\r\n    const used = Math.min(100, Math.round((rawUsed / 80) * 100));\r\n\r\n    // Write context metrics to bridge file for the context-monitor PostToolUse hook.\r\n    if (session) {\r\n      try {\r\n        const bridgePath = path.join(os.tmpdir(), `claude-ctx-${session}.json`);\r\n        const bridgeData = JSON.stringify({\r\n          session_id: session,\r\n          remaining_percentage: remaining,\r\n          used_pct: used,\r\n          timestamp: Math.floor(Date.now() / 1000),\r\n        });\r\n        fs.writeFileSync(bridgePath, bridgeData);\r\n      } catch {\r\n        // Silent fail -- bridge is best-effort, don't break statusline\r\n      }\r\n    }\r\n\r\n    // Build progress bar (10 segments)\r\n    const filled = Math.floor(used / 10);\r\n    const bar = '\\u2588'.repeat(filled) + '\\u2591'.repeat(10 - filled);\r\n\r\n    // Color based on scaled usage\r\n    if (used < 63) {\r\n      ctx = ` \\x1b[32m${bar} ${used}%\\x1b[0m`;\r\n    } else if (used < 81) {\r\n      ctx = ` \\x1b[33m${bar} ${used}%\\x1b[0m`;\r\n    } else if (used < 95) {\r\n      ctx = ` \\x1b[38;5;208m${bar} ${used}%\\x1b[0m`;\r\n    } else {\r\n      ctx = ` \\x1b[5;31m\\uD83D\\uDC80 ${bar} ${used}%\\x1b[0m`;\r\n    }\r\n  }\r\n\r\n  // Current task from todos\r\n  let task = '';\r\n  const homeDir = os.homedir();\r\n  const todosDir = path.join(homeDir, CLAUDE_DIR, 'todos');\r\n  if (session && fs.existsSync(todosDir)) {\r\n    try {\r\n      const files = fs.readdirSync(todosDir)\r\n        .filter((f: string) => f.startsWith(session) && f.includes('-agent-') && f.endsWith('.json'))\r\n        .map((f: string) => ({ name: f, mtime: fs.statSync(path.join(todosDir, f)).mtime }))\r\n        .sort((a: { mtime: Date }, b: { mtime: Date }) => b.mtime.getTime() - a.mtime.getTime());\r\n\r\n      if (files.length > 0) {\r\n        try {\r\n          const todos = JSON.parse(fs.readFileSync(path.join(todosDir, files[0].name), 'utf8'));\r\n          const inProgress = todos.find((t: { status: string; activeForm?: string }) => t.status === 'in_progress');\r\n          if (inProgress) task = inProgress.activeForm || '';\r\n        } catch {\r\n          // ignore\r\n        }\r\n      }\r\n    } catch {\r\n      // Silently fail on file system errors - don't break statusline\r\n    }\r\n  }\r\n\r\n  // MAXSIM update available?\r\n  let maxsimUpdate = '';\r\n  const cacheFile = path.join(homeDir, CLAUDE_DIR, 'cache', 'maxsim-update-check.json');\r\n  if (fs.existsSync(cacheFile)) {\r\n    try {\r\n      const cache = JSON.parse(fs.readFileSync(cacheFile, 'utf8'));\r\n      if (cache.update_available) {\r\n        maxsimUpdate = '\\x1b[33m\\u2B06 /maxsim:update\\x1b[0m \\u2502 ';\r\n      }\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }\r\n\r\n  // Output\r\n  const dirname = path.basename(dir);\r\n  if (task) {\r\n    return `${maxsimUpdate}\\x1b[2m${model}\\x1b[0m \\u2502 \\x1b[1m${task}\\x1b[0m \\u2502 \\x1b[2m${dirname}\\x1b[0m${ctx}`;\r\n  } else {\r\n    return `${maxsimUpdate}\\x1b[2m${model}\\x1b[0m \\u2502 \\x1b[2m${dirname}\\x1b[0m${ctx}`;\r\n  }\r\n}\r\n\r\n// Standalone entry\r\nif (require.main === module) {\r\n  readStdinJson<StatuslineInput>((data) => {\r\n    process.stdout.write(formatStatusline(data));\r\n  });\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQA,SAAgB,cAAiB,UAAmC;CAClE,IAAI,QAAQ;AACZ,SAAQ,MAAM,YAAY,OAAO;AACjC,SAAQ,MAAM,GAAG,SAAS,UAAmB,SAAS,MAAO;AAC7D,SAAQ,MAAM,GAAG,aAAa;AAC5B,MAAI;AAEF,YADa,KAAK,MAAM,MAAM,CAChB;UACR;AAEN,WAAQ,KAAK,EAAE;;GAEjB;;;AAIJ,MAAa,aAAa;;;;;;;;ACN1B,SAAgB,iBAAiB,MAA+B;CAC9D,MAAM,QAAQ,KAAK,OAAO,gBAAgB;CAC1C,MAAM,MAAM,KAAK,WAAW,eAAe,QAAQ,KAAK;CACxD,MAAM,UAAU,KAAK,cAAc;CACnC,MAAM,YAAY,KAAK,gBAAgB;CAGvC,IAAI,MAAM;AACV,KAAI,aAAa,MAAM;EACrB,MAAM,MAAM,KAAK,MAAM,UAAU;EACjC,MAAM,UAAU,KAAK,IAAI,GAAG,KAAK,IAAI,KAAK,MAAM,IAAI,CAAC;EAErD,MAAM,OAAO,KAAK,IAAI,KAAK,KAAK,MAAO,UAAU,KAAM,IAAI,CAAC;AAG5D,MAAI,QACF,KAAI;GACF,MAAM,aAAaA,UAAK,KAAKC,QAAG,QAAQ,EAAE,cAAc,QAAQ,OAAO;GACvE,MAAM,aAAa,KAAK,UAAU;IAChC,YAAY;IACZ,sBAAsB;IACtB,UAAU;IACV,WAAW,KAAK,MAAM,KAAK,KAAK,GAAG,IAAK;IACzC,CAAC;AACF,WAAG,cAAc,YAAY,WAAW;UAClC;EAMV,MAAM,SAAS,KAAK,MAAM,OAAO,GAAG;EACpC,MAAM,MAAM,IAAS,OAAO,OAAO,GAAG,IAAS,OAAO,KAAK,OAAO;AAGlE,MAAI,OAAO,GACT,OAAM,YAAY,IAAI,GAAG,KAAK;WACrB,OAAO,GAChB,OAAM,YAAY,IAAI,GAAG,KAAK;WACrB,OAAO,GAChB,OAAM,kBAAkB,IAAI,GAAG,KAAK;MAEpC,OAAM,2BAA2B,IAAI,GAAG,KAAK;;CAKjD,IAAI,OAAO;CACX,MAAM,UAAUA,QAAG,SAAS;CAC5B,MAAM,WAAWD,UAAK,KAAK,SAAS,YAAY,QAAQ;AACxD,KAAI,WAAWE,QAAG,WAAW,SAAS,CACpC,KAAI;EACF,MAAM,QAAQA,QAAG,YAAY,SAAS,CACnC,QAAQ,MAAc,EAAE,WAAW,QAAQ,IAAI,EAAE,SAAS,UAAU,IAAI,EAAE,SAAS,QAAQ,CAAC,CAC5F,KAAK,OAAe;GAAE,MAAM;GAAG,OAAOA,QAAG,SAASF,UAAK,KAAK,UAAU,EAAE,CAAC,CAAC;GAAO,EAAE,CACnF,MAAM,GAAoB,MAAuB,EAAE,MAAM,SAAS,GAAG,EAAE,MAAM,SAAS,CAAC;AAE1F,MAAI,MAAM,SAAS,EACjB,KAAI;GAEF,MAAM,aADQ,KAAK,MAAME,QAAG,aAAaF,UAAK,KAAK,UAAU,MAAM,GAAG,KAAK,EAAE,OAAO,CAAC,CAC5D,MAAM,MAA+C,EAAE,WAAW,cAAc;AACzG,OAAI,WAAY,QAAO,WAAW,cAAc;UAC1C;SAIJ;CAMV,IAAI,eAAe;CACnB,MAAM,YAAYA,UAAK,KAAK,SAAS,YAAY,SAAS,2BAA2B;AACrF,KAAIE,QAAG,WAAW,UAAU,CAC1B,KAAI;AAEF,MADc,KAAK,MAAMA,QAAG,aAAa,WAAW,OAAO,CAAC,CAClD,iBACR,gBAAe;SAEX;CAMV,MAAM,UAAUF,UAAK,SAAS,IAAI;AAClC,KAAI,KACF,QAAO,GAAG,aAAa,SAAS,MAAM,wBAAwB,KAAK,wBAAwB,QAAQ,SAAS;KAE5G,QAAO,GAAG,aAAa,SAAS,MAAM,wBAAwB,QAAQ,SAAS;;AAKnF,IAAI,QAAQ,SAAS,OACnB,gBAAgC,SAAS;AACvC,SAAQ,OAAO,MAAM,iBAAiB,KAAK,CAAC;EAC5C"}