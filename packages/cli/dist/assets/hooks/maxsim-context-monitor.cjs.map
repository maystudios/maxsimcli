{"version":3,"file":"maxsim-context-monitor.cjs","names":["os","path","fs"],"sources":["../../../src/hooks/shared.ts","../../../src/hooks/maxsim-context-monitor.ts"],"sourcesContent":["/**\n * Shared utilities for MAXSIM hooks.\n */\n\n/**\n * Read all stdin as a string, then invoke callback with parsed JSON.\n * Used by context-monitor and statusline hooks.\n */\nexport function readStdinJson<T>(callback: (data: T) => void): void {\n  let input = '';\n  process.stdin.setEncoding('utf8');\n  process.stdin.on('data', (chunk: string) => (input += chunk));\n  process.stdin.on('end', () => {\n    try {\n      const data = JSON.parse(input) as T;\n      callback(data);\n    } catch {\n      // Silent fail -- never block hook execution\n      process.exit(0);\n    }\n  });\n}\n\n/** The '.claude' path segment -- template marker replaced during install. */\nexport const CLAUDE_DIR = '.claude';\n","#!/usr/bin/env node\n/**\n * Context Monitor - PostToolUse hook\n * Reads context metrics from the statusline bridge file and injects\n * warnings when context usage is high.\n */\n\nimport * as fs from 'node:fs';\nimport * as os from 'node:os';\nimport * as path from 'node:path';\nimport { readStdinJson, CLAUDE_DIR } from './shared';\n\nexport const WARNING_THRESHOLD = 35;  // remaining_percentage <= 35%\nexport const CRITICAL_THRESHOLD = 25; // remaining_percentage <= 25%\nexport const STALE_SECONDS = 60;      // ignore metrics older than 60s\nexport const DEBOUNCE_CALLS = 5;      // min tool uses between warnings\n\nexport interface ContextMonitorInput {\n  session_id?: string;\n}\n\nexport interface ContextMonitorOutput {\n  hookSpecificOutput: {\n    hookEventName: string;\n    additionalContext: string;\n  };\n}\n\ninterface BridgeMetrics {\n  session_id: string;\n  remaining_percentage: number;\n  used_pct: number;\n  timestamp: number;\n}\n\ninterface WarnState {\n  callsSinceWarn: number;\n  lastLevel: string | null;\n}\n\nexport function processContextMonitor(data: ContextMonitorInput): ContextMonitorOutput | null {\n  const sessionId = data.session_id;\n\n  if (!sessionId) {\n    return null;\n  }\n\n  const tmpDir = os.tmpdir();\n  const metricsPath = path.join(tmpDir, `claude-ctx-${sessionId}.json`);\n\n  // If no metrics file, this is a subagent or fresh session -- exit silently\n  if (!fs.existsSync(metricsPath)) {\n    return null;\n  }\n\n  const metrics: BridgeMetrics = JSON.parse(fs.readFileSync(metricsPath, 'utf8'));\n  const now = Math.floor(Date.now() / 1000);\n\n  // Ignore stale metrics\n  if (metrics.timestamp && (now - metrics.timestamp) > STALE_SECONDS) {\n    return null;\n  }\n\n  const remaining = metrics.remaining_percentage;\n  const usedPct = metrics.used_pct;\n\n  // No warning needed\n  if (remaining > WARNING_THRESHOLD) {\n    return null;\n  }\n\n  // Debounce: check if we warned recently\n  const warnPath = path.join(tmpDir, `claude-ctx-${sessionId}-warned.json`);\n  let warnData: WarnState = { callsSinceWarn: 0, lastLevel: null };\n  let firstWarn = true;\n\n  if (fs.existsSync(warnPath)) {\n    try {\n      warnData = JSON.parse(fs.readFileSync(warnPath, 'utf8'));\n      firstWarn = false;\n    } catch {\n      // Corrupted file, reset\n    }\n  }\n\n  warnData.callsSinceWarn = (warnData.callsSinceWarn || 0) + 1;\n\n  const isCritical = remaining <= CRITICAL_THRESHOLD;\n  const currentLevel = isCritical ? 'critical' : 'warning';\n\n  // Emit immediately on first warning, then debounce subsequent ones\n  // Severity escalation (WARNING -> CRITICAL) bypasses debounce\n  const severityEscalated = currentLevel === 'critical' && warnData.lastLevel === 'warning';\n  if (!firstWarn && warnData.callsSinceWarn < DEBOUNCE_CALLS && !severityEscalated) {\n    // Update counter and exit without warning\n    fs.writeFileSync(warnPath, JSON.stringify(warnData));\n    return null;\n  }\n\n  // Reset debounce counter\n  warnData.callsSinceWarn = 0;\n  warnData.lastLevel = currentLevel;\n  fs.writeFileSync(warnPath, JSON.stringify(warnData));\n\n  // Build warning message\n  let message: string;\n  if (isCritical) {\n    message = `CONTEXT MONITOR CRITICAL: Usage at ${usedPct}%. Remaining: ${remaining}%. ` +\n      'STOP new work immediately. Save state NOW and inform the user that context is nearly exhausted. ' +\n      'If using MAXSIM, run /maxsim:pause-work to save execution state.';\n  } else {\n    message = `CONTEXT MONITOR WARNING: Usage at ${usedPct}%. Remaining: ${remaining}%. ` +\n      'Begin wrapping up current task. Do not start new complex work. ' +\n      'If using MAXSIM, consider /maxsim:pause-work to save state.';\n  }\n\n  return {\n    hookSpecificOutput: {\n      hookEventName: 'PostToolUse',\n      additionalContext: message,\n    },\n  };\n}\n\n// Standalone entry\nif (require.main === module) {\n  readStdinJson<ContextMonitorInput>((data) => {\n    const result = processContextMonitor(data);\n    if (result) {\n      process.stdout.write(JSON.stringify(result));\n    }\n  });\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQA,SAAgB,cAAiB,UAAmC;CAClE,IAAI,QAAQ;AACZ,SAAQ,MAAM,YAAY,OAAO;AACjC,SAAQ,MAAM,GAAG,SAAS,UAAmB,SAAS,MAAO;AAC7D,SAAQ,MAAM,GAAG,aAAa;AAC5B,MAAI;AAEF,YADa,KAAK,MAAM,MAAM,CAChB;UACR;AAEN,WAAQ,KAAK,EAAE;;GAEjB;;;;;;;;;;ACRJ,MAAa,oBAAoB;AACjC,MAAa,qBAAqB;AAClC,MAAa,gBAAgB;AAC7B,MAAa,iBAAiB;AAyB9B,SAAgB,sBAAsB,MAAwD;CAC5F,MAAM,YAAY,KAAK;AAEvB,KAAI,CAAC,UACH,QAAO;CAGT,MAAM,SAASA,QAAG,QAAQ;CAC1B,MAAM,cAAcC,UAAK,KAAK,QAAQ,cAAc,UAAU,OAAO;AAGrE,KAAI,CAACC,QAAG,WAAW,YAAY,CAC7B,QAAO;CAGT,MAAM,UAAyB,KAAK,MAAMA,QAAG,aAAa,aAAa,OAAO,CAAC;CAC/E,MAAM,MAAM,KAAK,MAAM,KAAK,KAAK,GAAG,IAAK;AAGzC,KAAI,QAAQ,aAAc,MAAM,QAAQ,YAAa,cACnD,QAAO;CAGT,MAAM,YAAY,QAAQ;CAC1B,MAAM,UAAU,QAAQ;AAGxB,KAAI,YAAY,kBACd,QAAO;CAIT,MAAM,WAAWD,UAAK,KAAK,QAAQ,cAAc,UAAU,cAAc;CACzE,IAAI,WAAsB;EAAE,gBAAgB;EAAG,WAAW;EAAM;CAChE,IAAI,YAAY;AAEhB,KAAIC,QAAG,WAAW,SAAS,CACzB,KAAI;AACF,aAAW,KAAK,MAAMA,QAAG,aAAa,UAAU,OAAO,CAAC;AACxD,cAAY;SACN;AAKV,UAAS,kBAAkB,SAAS,kBAAkB,KAAK;CAE3D,MAAM,aAAa,aAAa;CAChC,MAAM,eAAe,aAAa,aAAa;CAI/C,MAAM,oBAAoB,iBAAiB,cAAc,SAAS,cAAc;AAChF,KAAI,CAAC,aAAa,SAAS,iBAAiB,kBAAkB,CAAC,mBAAmB;AAEhF,UAAG,cAAc,UAAU,KAAK,UAAU,SAAS,CAAC;AACpD,SAAO;;AAIT,UAAS,iBAAiB;AAC1B,UAAS,YAAY;AACrB,SAAG,cAAc,UAAU,KAAK,UAAU,SAAS,CAAC;CAGpD,IAAI;AACJ,KAAI,WACF,WAAU,sCAAsC,QAAQ,gBAAgB,UAAU;KAIlF,WAAU,qCAAqC,QAAQ,gBAAgB,UAAU;AAKnF,QAAO,EACL,oBAAoB;EAClB,eAAe;EACf,mBAAmB;EACpB,EACF;;AAIH,IAAI,QAAQ,SAAS,OACnB,gBAAoC,SAAS;CAC3C,MAAM,SAAS,sBAAsB,KAAK;AAC1C,KAAI,OACF,SAAQ,OAAO,MAAM,KAAK,UAAU,OAAO,CAAC;EAE9C"}