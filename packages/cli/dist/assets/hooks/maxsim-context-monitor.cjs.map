{"version":3,"file":"maxsim-context-monitor.cjs","names":["os","path","fs"],"sources":["../../../src/hooks/shared.ts","../../../src/hooks/maxsim-context-monitor.ts"],"sourcesContent":["/**\r\n * Shared utilities for MAXSIM hooks.\r\n */\r\n\r\n/**\r\n * Read all stdin as a string, then invoke callback with parsed JSON.\r\n * Used by context-monitor and statusline hooks.\r\n */\r\nexport function readStdinJson<T>(callback: (data: T) => void): void {\r\n  let input = '';\r\n  process.stdin.setEncoding('utf8');\r\n  process.stdin.on('data', (chunk: string) => (input += chunk));\r\n  process.stdin.on('end', () => {\r\n    try {\r\n      const data = JSON.parse(input) as T;\r\n      callback(data);\r\n    } catch {\r\n      // Silent fail -- never block hook execution\r\n      process.exit(0);\r\n    }\r\n  });\r\n}\r\n\r\n/** The '.claude' path segment -- template marker replaced during install. */\r\nexport const CLAUDE_DIR = '.claude';\r\n","#!/usr/bin/env node\r\n/**\r\n * Context Monitor - PostToolUse hook\r\n * Reads context metrics from the statusline bridge file and injects\r\n * warnings when context usage is high.\r\n */\r\n\r\nimport * as fs from 'node:fs';\r\nimport * as os from 'node:os';\r\nimport * as path from 'node:path';\r\nimport { readStdinJson, CLAUDE_DIR } from './shared';\r\n\r\nexport const WARNING_THRESHOLD = 35;  // remaining_percentage <= 35%\r\nexport const CRITICAL_THRESHOLD = 25; // remaining_percentage <= 25%\r\nexport const STALE_SECONDS = 60;      // ignore metrics older than 60s\r\nexport const DEBOUNCE_CALLS = 5;      // min tool uses between warnings\r\n\r\nexport interface ContextMonitorInput {\r\n  session_id?: string;\r\n}\r\n\r\nexport interface ContextMonitorOutput {\r\n  hookSpecificOutput: {\r\n    hookEventName: string;\r\n    additionalContext: string;\r\n  };\r\n}\r\n\r\ninterface BridgeMetrics {\r\n  session_id: string;\r\n  remaining_percentage: number;\r\n  used_pct: number;\r\n  timestamp: number;\r\n}\r\n\r\ninterface WarnState {\r\n  callsSinceWarn: number;\r\n  lastLevel: string | null;\r\n}\r\n\r\nexport function processContextMonitor(data: ContextMonitorInput): ContextMonitorOutput | null {\r\n  const sessionId = data.session_id;\r\n\r\n  if (!sessionId) {\r\n    return null;\r\n  }\r\n\r\n  const tmpDir = os.tmpdir();\r\n  const metricsPath = path.join(tmpDir, `claude-ctx-${sessionId}.json`);\r\n\r\n  // If no metrics file, this is a subagent or fresh session -- exit silently\r\n  if (!fs.existsSync(metricsPath)) {\r\n    return null;\r\n  }\r\n\r\n  const metrics: BridgeMetrics = JSON.parse(fs.readFileSync(metricsPath, 'utf8'));\r\n  const now = Math.floor(Date.now() / 1000);\r\n\r\n  // Ignore stale metrics\r\n  if (metrics.timestamp && (now - metrics.timestamp) > STALE_SECONDS) {\r\n    return null;\r\n  }\r\n\r\n  const remaining = metrics.remaining_percentage;\r\n  const usedPct = metrics.used_pct;\r\n\r\n  // No warning needed\r\n  if (remaining > WARNING_THRESHOLD) {\r\n    return null;\r\n  }\r\n\r\n  // Debounce: check if we warned recently\r\n  const warnPath = path.join(tmpDir, `claude-ctx-${sessionId}-warned.json`);\r\n  let warnData: WarnState = { callsSinceWarn: 0, lastLevel: null };\r\n  let firstWarn = true;\r\n\r\n  if (fs.existsSync(warnPath)) {\r\n    try {\r\n      warnData = JSON.parse(fs.readFileSync(warnPath, 'utf8'));\r\n      firstWarn = false;\r\n    } catch {\r\n      // Corrupted file, reset\r\n    }\r\n  }\r\n\r\n  warnData.callsSinceWarn = (warnData.callsSinceWarn || 0) + 1;\r\n\r\n  const isCritical = remaining <= CRITICAL_THRESHOLD;\r\n  const currentLevel = isCritical ? 'critical' : 'warning';\r\n\r\n  // Emit immediately on first warning, then debounce subsequent ones\r\n  // Severity escalation (WARNING -> CRITICAL) bypasses debounce\r\n  const severityEscalated = currentLevel === 'critical' && warnData.lastLevel === 'warning';\r\n  if (!firstWarn && warnData.callsSinceWarn < DEBOUNCE_CALLS && !severityEscalated) {\r\n    // Update counter and exit without warning\r\n    fs.writeFileSync(warnPath, JSON.stringify(warnData));\r\n    return null;\r\n  }\r\n\r\n  // Reset debounce counter\r\n  warnData.callsSinceWarn = 0;\r\n  warnData.lastLevel = currentLevel;\r\n  fs.writeFileSync(warnPath, JSON.stringify(warnData));\r\n\r\n  // Build warning message\r\n  let message: string;\r\n  if (isCritical) {\r\n    message = `CONTEXT MONITOR CRITICAL: Usage at ${usedPct}%. Remaining: ${remaining}%. ` +\r\n      'STOP new work immediately. Save state NOW and inform the user that context is nearly exhausted. ' +\r\n      'If using MAXSIM, run /maxsim:pause-work to save execution state.';\r\n  } else {\r\n    message = `CONTEXT MONITOR WARNING: Usage at ${usedPct}%. Remaining: ${remaining}%. ` +\r\n      'Begin wrapping up current task. Do not start new complex work. ' +\r\n      'If using MAXSIM, consider /maxsim:pause-work to save state.';\r\n  }\r\n\r\n  return {\r\n    hookSpecificOutput: {\r\n      hookEventName: 'PostToolUse',\r\n      additionalContext: message,\r\n    },\r\n  };\r\n}\r\n\r\n// Standalone entry\r\nif (require.main === module) {\r\n  readStdinJson<ContextMonitorInput>((data) => {\r\n    const result = processContextMonitor(data);\r\n    if (result) {\r\n      process.stdout.write(JSON.stringify(result));\r\n    }\r\n  });\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQA,SAAgB,cAAiB,UAAmC;CAClE,IAAI,QAAQ;AACZ,SAAQ,MAAM,YAAY,OAAO;AACjC,SAAQ,MAAM,GAAG,SAAS,UAAmB,SAAS,MAAO;AAC7D,SAAQ,MAAM,GAAG,aAAa;AAC5B,MAAI;AAEF,YADa,KAAK,MAAM,MAAM,CAChB;UACR;AAEN,WAAQ,KAAK,EAAE;;GAEjB;;;;;;;;;;ACRJ,MAAa,oBAAoB;AACjC,MAAa,qBAAqB;AAClC,MAAa,gBAAgB;AAC7B,MAAa,iBAAiB;AAyB9B,SAAgB,sBAAsB,MAAwD;CAC5F,MAAM,YAAY,KAAK;AAEvB,KAAI,CAAC,UACH,QAAO;CAGT,MAAM,SAASA,QAAG,QAAQ;CAC1B,MAAM,cAAcC,UAAK,KAAK,QAAQ,cAAc,UAAU,OAAO;AAGrE,KAAI,CAACC,QAAG,WAAW,YAAY,CAC7B,QAAO;CAGT,MAAM,UAAyB,KAAK,MAAMA,QAAG,aAAa,aAAa,OAAO,CAAC;CAC/E,MAAM,MAAM,KAAK,MAAM,KAAK,KAAK,GAAG,IAAK;AAGzC,KAAI,QAAQ,aAAc,MAAM,QAAQ,YAAa,cACnD,QAAO;CAGT,MAAM,YAAY,QAAQ;CAC1B,MAAM,UAAU,QAAQ;AAGxB,KAAI,YAAY,kBACd,QAAO;CAIT,MAAM,WAAWD,UAAK,KAAK,QAAQ,cAAc,UAAU,cAAc;CACzE,IAAI,WAAsB;EAAE,gBAAgB;EAAG,WAAW;EAAM;CAChE,IAAI,YAAY;AAEhB,KAAIC,QAAG,WAAW,SAAS,CACzB,KAAI;AACF,aAAW,KAAK,MAAMA,QAAG,aAAa,UAAU,OAAO,CAAC;AACxD,cAAY;SACN;AAKV,UAAS,kBAAkB,SAAS,kBAAkB,KAAK;CAE3D,MAAM,aAAa,aAAa;CAChC,MAAM,eAAe,aAAa,aAAa;CAI/C,MAAM,oBAAoB,iBAAiB,cAAc,SAAS,cAAc;AAChF,KAAI,CAAC,aAAa,SAAS,iBAAiB,kBAAkB,CAAC,mBAAmB;AAEhF,UAAG,cAAc,UAAU,KAAK,UAAU,SAAS,CAAC;AACpD,SAAO;;AAIT,UAAS,iBAAiB;AAC1B,UAAS,YAAY;AACrB,SAAG,cAAc,UAAU,KAAK,UAAU,SAAS,CAAC;CAGpD,IAAI;AACJ,KAAI,WACF,WAAU,sCAAsC,QAAQ,gBAAgB,UAAU;KAIlF,WAAU,qCAAqC,QAAQ,gBAAgB,UAAU;AAKnF,QAAO,EACL,oBAAoB;EAClB,eAAe;EACf,mBAAmB;EACpB,EACF;;AAIH,IAAI,QAAQ,SAAS,OACnB,gBAAoC,SAAS;CAC3C,MAAM,SAAS,sBAAsB,KAAK;AAC1C,KAAI,OACF,SAAQ,OAAO,MAAM,KAAK,UAAU,OAAO,CAAC;EAE9C"}