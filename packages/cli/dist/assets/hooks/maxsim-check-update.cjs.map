{"version":3,"file":"maxsim-check-update.cjs","names":["path","fs","os"],"sources":["../../../src/hooks/shared.ts","../../../src/hooks/maxsim-check-update.ts"],"sourcesContent":["/**\n * Shared utilities for MAXSIM hooks.\n */\n\n/**\n * Read all stdin as a string, then invoke callback with parsed JSON.\n * Used by context-monitor and statusline hooks.\n */\nexport function readStdinJson<T>(callback: (data: T) => void): void {\n  let input = '';\n  process.stdin.setEncoding('utf8');\n  process.stdin.on('data', (chunk: string) => (input += chunk));\n  process.stdin.on('end', () => {\n    try {\n      const data = JSON.parse(input) as T;\n      callback(data);\n    } catch {\n      // Silent fail -- never block hook execution\n      process.exit(0);\n    }\n  });\n}\n\n/** The '.claude' path segment -- template marker replaced during install. */\nexport const CLAUDE_DIR = '.claude';\n","#!/usr/bin/env node\n/**\n * Check for MAXSIM updates in background, write result to cache.\n * Called by SessionStart hook - runs once per session.\n */\n\nimport * as fs from 'node:fs';\nimport * as path from 'node:path';\nimport * as os from 'node:os';\nimport { spawn } from 'node:child_process';\nimport { CLAUDE_DIR } from './shared';\n\nexport interface UpdateCheckResult {\n  update_available: boolean;\n  installed: string;\n  latest: string;\n  checked: number;\n}\n\nexport interface CheckForUpdateOptions {\n  homeDir: string;\n  cwd: string;\n}\n\nexport function checkForUpdate(options: CheckForUpdateOptions): void {\n  const { homeDir, cwd } = options;\n  const cacheDir = path.join(homeDir, CLAUDE_DIR, 'cache');\n  const cacheFile = path.join(cacheDir, 'maxsim-update-check.json');\n\n  // VERSION file locations (check project first, then global)\n  const projectVersionFile = path.join(cwd, CLAUDE_DIR, 'maxsim', 'VERSION');\n  const globalVersionFile = path.join(homeDir, CLAUDE_DIR, 'maxsim', 'VERSION');\n\n  // Ensure cache directory exists\n  if (!fs.existsSync(cacheDir)) {\n    fs.mkdirSync(cacheDir, { recursive: true });\n  }\n\n  // Run check in background (spawn background process, windowsHide prevents console flash)\n  const child = spawn(process.execPath, ['-e', `\n  const fs = require('fs');\n  const { execSync } = require('child_process');\n\n  const cacheFile = ${JSON.stringify(cacheFile)};\n  const projectVersionFile = ${JSON.stringify(projectVersionFile)};\n  const globalVersionFile = ${JSON.stringify(globalVersionFile)};\n\n  // Check project directory first (local install), then global\n  let installed = '0.0.0';\n  try {\n    if (fs.existsSync(projectVersionFile)) {\n      installed = fs.readFileSync(projectVersionFile, 'utf8').trim();\n    } else if (fs.existsSync(globalVersionFile)) {\n      installed = fs.readFileSync(globalVersionFile, 'utf8').trim();\n    }\n  } catch (e) {}\n\n  let latest = null;\n  try {\n    latest = execSync('npm view maxsimcli version', { encoding: 'utf8', timeout: 10000, windowsHide: true }).trim();\n  } catch (e) {}\n\n  const result = {\n    update_available: latest && installed !== latest,\n    installed,\n    latest: latest || 'unknown',\n    checked: Math.floor(Date.now() / 1000)\n  };\n\n  fs.writeFileSync(cacheFile, JSON.stringify(result));\n`], {\n    stdio: 'ignore',\n    windowsHide: true,\n    detached: true,\n  });\n\n  child.unref();\n}\n\n// Standalone entry\nif (require.main === module) {\n  checkForUpdate({ homeDir: os.homedir(), cwd: process.cwd() });\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwBA,MAAa,aAAa;;;;;;;;ACA1B,SAAgB,eAAe,SAAsC;CACnE,MAAM,EAAE,SAAS,QAAQ;CACzB,MAAM,WAAWA,UAAK,KAAK,SAAS,YAAY,QAAQ;CACxD,MAAM,YAAYA,UAAK,KAAK,UAAU,2BAA2B;CAGjE,MAAM,qBAAqBA,UAAK,KAAK,KAAK,YAAY,UAAU,UAAU;CAC1E,MAAM,oBAAoBA,UAAK,KAAK,SAAS,YAAY,UAAU,UAAU;AAG7E,KAAI,CAACC,QAAG,WAAW,SAAS,CAC1B,SAAG,UAAU,UAAU,EAAE,WAAW,MAAM,CAAC;AAyC7C,+BArCoB,QAAQ,UAAU,CAAC,MAAM;;;;sBAIzB,KAAK,UAAU,UAAU,CAAC;+BACjB,KAAK,UAAU,mBAAmB,CAAC;8BACpC,KAAK,UAAU,kBAAkB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;EAyB9D,EAAE;EACA,OAAO;EACP,aAAa;EACb,UAAU;EACX,CAAC,CAEI,OAAO;;AAIf,IAAI,QAAQ,SAAS,OACnB,gBAAe;CAAE,SAASC,QAAG,SAAS;CAAE,KAAK,QAAQ,KAAK;CAAE,CAAC"}