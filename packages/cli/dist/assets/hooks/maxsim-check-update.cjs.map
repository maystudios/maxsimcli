{"version":3,"file":"maxsim-check-update.cjs","names":["path","fs","os"],"sources":["../../../src/hooks/shared.ts","../../../src/hooks/maxsim-check-update.ts"],"sourcesContent":["/**\r\n * Shared utilities for MAXSIM hooks.\r\n */\r\n\r\n/**\r\n * Read all stdin as a string, then invoke callback with parsed JSON.\r\n * Used by context-monitor and statusline hooks.\r\n */\r\nexport function readStdinJson<T>(callback: (data: T) => void): void {\r\n  let input = '';\r\n  process.stdin.setEncoding('utf8');\r\n  process.stdin.on('data', (chunk: string) => (input += chunk));\r\n  process.stdin.on('end', () => {\r\n    try {\r\n      const data = JSON.parse(input) as T;\r\n      callback(data);\r\n    } catch {\r\n      // Silent fail -- never block hook execution\r\n      process.exit(0);\r\n    }\r\n  });\r\n}\r\n\r\n/** The '.claude' path segment -- template marker replaced during install. */\r\nexport const CLAUDE_DIR = '.claude';\r\n","#!/usr/bin/env node\r\n/**\r\n * Check for MAXSIM updates in background, write result to cache.\r\n * Called by SessionStart hook - runs once per session.\r\n */\r\n\r\nimport * as fs from 'node:fs';\r\nimport * as path from 'node:path';\r\nimport * as os from 'node:os';\r\nimport { spawn } from 'node:child_process';\r\nimport { CLAUDE_DIR } from './shared';\r\n\r\nexport interface UpdateCheckResult {\r\n  update_available: boolean;\r\n  installed: string;\r\n  latest: string;\r\n  checked: number;\r\n}\r\n\r\nexport interface CheckForUpdateOptions {\r\n  homeDir: string;\r\n  cwd: string;\r\n}\r\n\r\nexport function checkForUpdate(options: CheckForUpdateOptions): void {\r\n  const { homeDir, cwd } = options;\r\n  const cacheDir = path.join(homeDir, CLAUDE_DIR, 'cache');\r\n  const cacheFile = path.join(cacheDir, 'maxsim-update-check.json');\r\n\r\n  // VERSION file locations (check project first, then global)\r\n  const projectVersionFile = path.join(cwd, CLAUDE_DIR, 'maxsim', 'VERSION');\r\n  const globalVersionFile = path.join(homeDir, CLAUDE_DIR, 'maxsim', 'VERSION');\r\n\r\n  // Ensure cache directory exists\r\n  if (!fs.existsSync(cacheDir)) {\r\n    fs.mkdirSync(cacheDir, { recursive: true });\r\n  }\r\n\r\n  // Run check in background (spawn background process, windowsHide prevents console flash)\r\n  const child = spawn(process.execPath, ['-e', `\r\n  const fs = require('fs');\r\n  const { execSync } = require('child_process');\r\n\r\n  const cacheFile = ${JSON.stringify(cacheFile)};\r\n  const projectVersionFile = ${JSON.stringify(projectVersionFile)};\r\n  const globalVersionFile = ${JSON.stringify(globalVersionFile)};\r\n\r\n  // Check project directory first (local install), then global\r\n  let installed = '0.0.0';\r\n  try {\r\n    if (fs.existsSync(projectVersionFile)) {\r\n      installed = fs.readFileSync(projectVersionFile, 'utf8').trim();\r\n    } else if (fs.existsSync(globalVersionFile)) {\r\n      installed = fs.readFileSync(globalVersionFile, 'utf8').trim();\r\n    }\r\n  } catch (e) {}\r\n\r\n  let latest = null;\r\n  try {\r\n    latest = execSync('npm view maxsimcli version', { encoding: 'utf8', timeout: 10000, windowsHide: true }).trim();\r\n  } catch (e) {}\r\n\r\n  const result = {\r\n    update_available: latest && installed !== latest,\r\n    installed,\r\n    latest: latest || 'unknown',\r\n    checked: Math.floor(Date.now() / 1000)\r\n  };\r\n\r\n  fs.writeFileSync(cacheFile, JSON.stringify(result));\r\n`], {\r\n    stdio: 'ignore',\r\n    windowsHide: true,\r\n    detached: true,\r\n  });\r\n\r\n  child.unref();\r\n}\r\n\r\n// Standalone entry\r\nif (require.main === module) {\r\n  checkForUpdate({ homeDir: os.homedir(), cwd: process.cwd() });\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwBA,MAAa,aAAa;;;;;;;;ACA1B,SAAgB,eAAe,SAAsC;CACnE,MAAM,EAAE,SAAS,QAAQ;CACzB,MAAM,WAAWA,UAAK,KAAK,SAAS,YAAY,QAAQ;CACxD,MAAM,YAAYA,UAAK,KAAK,UAAU,2BAA2B;CAGjE,MAAM,qBAAqBA,UAAK,KAAK,KAAK,YAAY,UAAU,UAAU;CAC1E,MAAM,oBAAoBA,UAAK,KAAK,SAAS,YAAY,UAAU,UAAU;AAG7E,KAAI,CAACC,QAAG,WAAW,SAAS,CAC1B,SAAG,UAAU,UAAU,EAAE,WAAW,MAAM,CAAC;AAyC7C,+BArCoB,QAAQ,UAAU,CAAC,MAAM;;;;sBAIzB,KAAK,UAAU,UAAU,CAAC;+BACjB,KAAK,UAAU,mBAAmB,CAAC;8BACpC,KAAK,UAAU,kBAAkB,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;EAyB9D,EAAE;EACA,OAAO;EACP,aAAa;EACb,UAAU;EACX,CAAC,CAEI,OAAO;;AAIf,IAAI,QAAQ,SAAS,OACnB,gBAAe;CAAE,SAASC,QAAG,SAAS;CAAE,KAAK,QAAQ,KAAK;CAAE,CAAC"}