---
phase: 13-live-project-dashboard
plan: 07
type: execute
wave: 4
depends_on: ["13-02"]
files_modified:
  - packages/cli/src/cli.ts
  - packages/cli/src/install.ts
  - packages/dashboard/package.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running 'maxsim dashboard' from CLI launches the dashboard as a detached subprocess"
    - "Dashboard subprocess stays alive after the CLI process exits"
    - "MAXSIM_PROJECT_CWD environment variable is passed to the subprocess"
    - "Dashboard opens automatically in the default browser"
    - "If dashboard is already running on the expected port, CLI prints the URL instead of starting a new instance"
  artifacts:
    - path: "packages/cli/src/cli.ts"
      provides: "Dashboard launch command in CLI dispatch router"
      contains: "dashboard"
    - path: "packages/dashboard/package.json"
      provides: "Updated with a start script for production server"
  key_links:
    - from: "packages/cli/src/cli.ts"
      to: "packages/dashboard/server.ts"
      via: "subprocess spawn with detached: true"
      pattern: "spawn.*dashboard"
---

<objective>
Integrate the dashboard into the MAXSIM CLI so it can be launched via `maxsim dashboard` command and as a subprocess during phase execution.

Purpose: Make the dashboard accessible from the existing MAXSIM CLI workflow -- both as a manual command and as an auto-launched companion during phase execution.
Output: A `dashboard` command in the CLI dispatch router that spawns the dashboard as a detached subprocess, passing the project CWD via environment variable.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-live-project-dashboard/13-CONTEXT.md
@.planning/phases/13-live-project-dashboard/13-02-SUMMARY.md
@packages/cli/src/cli.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dashboard launch command to CLI dispatch router</name>
  <files>
    packages/cli/src/cli.ts
  </files>
  <action>
  Add a `dashboard` command case to the CLI dispatch router in `packages/cli/src/cli.ts`:

  1. In the switch statement or command dispatch, add `case 'dashboard':`:
     - Resolve the dashboard server entry point: Use `require.resolve('@maxsim/dashboard/package.json')` then `path.join(path.dirname(resolved), 'server.js')` (for production built output) or `server.ts` (for dev via tsx)
     - Determine if running in dev or production mode
     - Check if dashboard is already running: Try `fetch(`http://localhost:3333`)` (or range 3333-3343) with a short timeout. If reachable, print URL and exit.
     - If not running, spawn as detached subprocess:
       ```typescript
       const child = spawn('node', [serverPath], {
         cwd: process.cwd(),
         detached: true,
         stdio: 'ignore',
         env: {
           ...process.env,
           MAXSIM_PROJECT_CWD: process.cwd(),
           NODE_ENV: 'production',
         },
       });
       child.unref();
       ```
     - Print "Dashboard starting..." message
     - For dev mode: use `tsx` instead of `node` to run `.ts` directly

  2. Add `@maxsim/dashboard` as a `workspace:*` dependency in `packages/cli/package.json` devDependencies (it's a private package, not published — resolved at development time via pnpm workspace)

  3. Handle the `--stop` flag: If `maxsim dashboard --stop` is passed, find and kill the dashboard process (via PID file or port check)

  Note: The dashboard package needs to be built first (`nx build dashboard`) before the CLI can launch it in production mode. For development, `tsx` handles TypeScript directly.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim && npx nx build cli 2>&1 | tail -10</automated>
  </verify>
  <done>CLI dispatch router has a 'dashboard' command that spawns the dashboard as a detached subprocess with MAXSIM_PROJECT_CWD set; already-running detection prevents duplicate instances</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-launch hook for execute-phase workflow</name>
  <files>
    packages/dashboard/package.json
  </files>
  <action>
  1. **packages/dashboard/package.json** — Ensure the `start` script is correct for production launch:
     - `"start": "node server.js"` (assumes server.ts is compiled to server.js)
     - Add a `"build:server"` script to compile server.ts separately (using tsdown or tsx): `"build:server": "npx tsdown server.ts --format esm --out-dir ."`
     - Or alternatively, since Next.js `output: "standalone"` generates `.next/standalone/`, include server.ts compilation in the build pipeline

  2. **Document the auto-launch pattern** for the execute-phase workflow (via MAXSIM command files, not code):
     - The execute-phase workflow file will call `maxsim dashboard` at the start of phase execution
     - This is handled by updating the MAXSIM command/workflow markdown files (not TypeScript code)
     - For now, just ensure the CLI `dashboard` command works correctly when called from a workflow context
     - The dashboard command should be idempotent: if already running, just print URL

  3. Create a minimal health check endpoint at `/api/health` in the dashboard:
     - Returns `{ status: "ok", port, cwd, uptime }`
     - Used by the CLI to detect if dashboard is already running
     - Add `packages/dashboard/app/api/health/route.ts`
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx next build 2>&1 | tail -5</automated>
  </verify>
  <done>Dashboard has correct start script for production, health endpoint for already-running detection, and build pipeline for server.ts</done>
</task>

</tasks>

<verification>
1. `nx build cli` succeeds with dashboard command in dispatch router
2. `nx build dashboard` produces buildable output
3. Dashboard health endpoint at /api/health returns JSON
4. CLI `dashboard` command creates detached subprocess with correct env vars
5. Re-running `dashboard` when already running prints URL instead of starting duplicate
</verification>

<success_criteria>
- `maxsim dashboard` CLI command launches dashboard as detached subprocess
- Dashboard stays alive after CLI exits
- MAXSIM_PROJECT_CWD is correctly passed
- Already-running detection prevents duplicate instances
- Health endpoint available for status checks
</success_criteria>

<output>
After completion, create `.planning/phases/13-live-project-dashboard/13-07-SUMMARY.md`
</output>
