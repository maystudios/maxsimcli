---
phase: 13-live-project-dashboard
plan: 07
type: execute
wave: 3
depends_on: ["13-01", "13-03"]
files_modified:
  - packages/cli/src/cli.ts
  - packages/dashboard/package.json
  - packages/dashboard/app/api/health/route.ts
  - packages/templates/workflows/execute-phase.md
  - packages/templates/commands/maxsim/execute-phase.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running 'maxsim dashboard' from CLI launches the dashboard as a detached subprocess"
    - "Dashboard subprocess stays alive after the CLI process exits"
    - "MAXSIM_PROJECT_CWD environment variable is passed to the subprocess"
    - "Dashboard opens automatically in the default browser"
    - "If dashboard is already running on the expected port, CLI prints the URL instead of starting a new instance"
    - "The execute-phase workflow auto-launches the dashboard at phase execution start"
  artifacts:
    - path: "packages/cli/src/cli.ts"
      provides: "Dashboard launch command in CLI dispatch router"
      contains: "dashboard"
    - path: "packages/dashboard/package.json"
      provides: "Updated with start and build:server scripts for production server"
    - path: "packages/dashboard/app/api/health/route.ts"
      provides: "Health check endpoint returning status, port, cwd, uptime"
      exports: ["GET"]
    - path: "packages/templates/workflows/execute-phase.md"
      provides: "Updated execute-phase workflow with dashboard auto-launch step"
      contains: "maxsim dashboard"
  key_links:
    - from: "packages/cli/src/cli.ts"
      to: "packages/dashboard/server.ts"
      via: "subprocess spawn with detached: true"
      pattern: "spawn.*dashboard"
    - from: "packages/templates/workflows/execute-phase.md"
      to: "packages/cli/src/cli.ts"
      via: "workflow step calls maxsim dashboard CLI command"
      pattern: "maxsim dashboard"
    - from: "packages/cli/src/cli.ts"
      to: "packages/dashboard/app/api/health/route.ts"
      via: "health check fetch to detect already-running dashboard"
      pattern: "fetch.*health"
---

<objective>
Integrate the dashboard into the MAXSIM CLI so it can be launched via `maxsim dashboard` command and auto-launched during `/maxsim:execute-phase`.

Purpose: Make the dashboard accessible from the existing MAXSIM CLI workflow -- both as a manual command and as an auto-launched companion during phase execution. This fulfills the locked user decision: "Dual launch mode: auto-started during /maxsim:execute-phase AND manually via maxsim dashboard CLI command."
Output: A `dashboard` command in the CLI dispatch router, a health check API endpoint, updated build pipeline, and modified execute-phase workflow markdown for auto-launch.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-live-project-dashboard/13-CONTEXT.md
@.planning/phases/13-live-project-dashboard/13-02-SUMMARY.md
@.planning/phases/13-live-project-dashboard/13-03-SUMMARY.md
@packages/cli/src/cli.ts
@packages/templates/workflows/execute-phase.md
@packages/templates/commands/maxsim/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dashboard launch command to CLI dispatch router</name>
  <files>
    packages/cli/src/cli.ts
  </files>
  <action>
  Add a `dashboard` command case to the CLI dispatch router in `packages/cli/src/cli.ts`:

  1. In the switch statement or command dispatch, add `case 'dashboard':`:
     - Resolve the dashboard server entry point: Use `require.resolve('@maxsim/dashboard/package.json')` then `path.join(path.dirname(resolved), 'server.js')` (for production built output) or `server.ts` (for dev via tsx)
     - Determine if running in dev or production mode
     - Check if dashboard is already running: Try `fetch(`http://localhost:3333/api/health`)` (or range 3333-3343) with a short timeout. If reachable and returns `{ status: "ok" }`, print URL and exit.
     - If not running, spawn as detached subprocess:
       ```typescript
       const child = spawn('node', [serverPath], {
         cwd: process.cwd(),
         detached: true,
         stdio: 'ignore',
         env: {
           ...process.env,
           MAXSIM_PROJECT_CWD: process.cwd(),
           NODE_ENV: 'production',
         },
       });
       child.unref();
       ```
     - Print "Dashboard starting..." message
     - For dev mode: use `tsx` instead of `node` to run `.ts` directly

  2. Add `@maxsim/dashboard` as a `workspace:*` dependency in `packages/cli/package.json` devDependencies (it's a private package, not published -- resolved at development time via pnpm workspace)

  3. Handle the `--stop` flag: If `maxsim dashboard --stop` is passed, find and kill the dashboard process (via PID file or port check)

  Note: The dashboard package needs to be built first (`nx build dashboard`) before the CLI can launch it in production mode. For development, `tsx` handles TypeScript directly.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim && npx nx build cli 2>&1 | tail -10</automated>
  </verify>
  <done>CLI dispatch router has a 'dashboard' command that spawns the dashboard as a detached subprocess with MAXSIM_PROJECT_CWD set; already-running detection via /api/health prevents duplicate instances</done>
</task>

<task type="auto">
  <name>Task 2a: Update dashboard package.json build pipeline</name>
  <files>
    packages/dashboard/package.json
  </files>
  <action>
  Update `packages/dashboard/package.json` to ensure the build pipeline is correct for production launch:

  1. Ensure the `start` script is correct: `"start": "node server.js"` (assumes server.ts is compiled to server.js)
  2. Add a `"build:server"` script to compile server.ts separately (using tsdown or tsx): `"build:server": "npx tsdown server.ts --format esm --out-dir ."`
  3. Or alternatively, since Next.js `output: "standalone"` generates `.next/standalone/`, include server.ts compilation in the build pipeline
  4. Ensure the `build` script chains both Next.js build and server compilation: `"build": "next build && npm run build:server"`

  The dashboard command in the CLI should be idempotent: if already running, just print URL.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx next build 2>&1 | tail -5</automated>
  </verify>
  <done>Dashboard has correct start script for production and build pipeline that compiles both Next.js app and server.ts</done>
</task>

<task type="auto">
  <name>Task 2b: Create health check API endpoint</name>
  <files>
    packages/dashboard/app/api/health/route.ts
  </files>
  <action>
  Create a minimal health check endpoint at `/api/health` in the dashboard:

  1. **app/api/health/route.ts** -- `GET`:
     - Returns `{ status: "ok", port: process.env.PORT || 3333, cwd: process.env.MAXSIM_PROJECT_CWD || process.cwd(), uptime: process.uptime() }`
     - Used by the CLI to detect if dashboard is already running
     - No authentication required (local-only tool)
     - Returns 200 with JSON response
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>Health endpoint at /api/health returns JSON with status, port, cwd, and uptime for already-running detection</done>
</task>

<task type="auto">
  <name>Task 3: Add dashboard auto-launch to execute-phase workflow</name>
  <files>
    packages/templates/workflows/execute-phase.md
    packages/templates/commands/maxsim/execute-phase.md
  </files>
  <action>
  Modify the execute-phase workflow markdown to auto-launch the dashboard at the start of phase execution. This implements the locked user decision: "Dual launch mode: auto-started during /maxsim:execute-phase."

  1. **packages/templates/workflows/execute-phase.md** -- Add a new step after `initialize` and before `handle_branching`:
     ```markdown
     <step name="launch_dashboard">
     Launch the live project dashboard (if not already running):

     ```bash
     maxsim dashboard
     ```

     This is idempotent: if the dashboard is already running, it prints the URL. If not, it spawns a detached subprocess that survives the execute-phase session.

     The dashboard provides a real-time visual companion showing phase progress, plan tasks, and blockers as execution proceeds.
     </step>
     ```

  2. **packages/templates/commands/maxsim/execute-phase.md** -- No changes needed to the command file itself (the workflow file drives the behavior). Verify the command's `allowed-tools` already includes `Bash` (it does), which is needed to run `maxsim dashboard`.

  The auto-launch is best-effort: if the dashboard fails to start (e.g., not installed), execution continues without it. Do NOT gate phase execution on dashboard availability.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim && grep -c "launch_dashboard\|maxsim dashboard" packages/templates/workflows/execute-phase.md</automated>
  </verify>
  <done>Execute-phase workflow includes a launch_dashboard step that calls `maxsim dashboard` at the start of phase execution; dashboard auto-starts as a companion to phase execution</done>
</task>

</tasks>

<verification>
1. `nx build cli` succeeds with dashboard command in dispatch router
2. `nx build dashboard` produces buildable output with server compilation
3. Dashboard health endpoint at /api/health returns JSON
4. CLI `dashboard` command creates detached subprocess with correct env vars
5. Re-running `dashboard` when already running prints URL instead of starting duplicate
6. Execute-phase workflow markdown contains a `launch_dashboard` step that calls `maxsim dashboard`
</verification>

<success_criteria>
- `maxsim dashboard` CLI command launches dashboard as detached subprocess
- Dashboard stays alive after CLI exits
- MAXSIM_PROJECT_CWD is correctly passed
- Already-running detection via /api/health prevents duplicate instances
- Health endpoint available for status checks
- Execute-phase workflow auto-launches dashboard at phase execution start (locked decision fulfilled)
</success_criteria>

<output>
After completion, create `.planning/phases/13-live-project-dashboard/13-07-SUMMARY.md`
</output>
