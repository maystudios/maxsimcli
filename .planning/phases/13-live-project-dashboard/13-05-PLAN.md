---
phase: 13-live-project-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - packages/dashboard/app/components/dashboard/phase-detail.tsx
  - packages/dashboard/app/components/dashboard/plan-card.tsx
  - packages/dashboard/app/components/dashboard/task-list.tsx
  - packages/dashboard/app/components/editor/plan-editor.tsx
  - packages/dashboard/app/hooks/use-phase-detail.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Clicking a phase in the overview shows a detail view with all plans and their tasks"
    - "Task checkboxes can be toggled and the change is written back to the PLAN.md file immediately"
    - "Full plan content can be edited in a CodeMirror Markdown editor with syntax highlighting"
    - "Editor has a save button that writes content back via PUT /api/plan/[...path]"
    - "Phase detail shows context and research status if available"
  artifacts:
    - path: "packages/dashboard/app/components/dashboard/phase-detail.tsx"
      provides: "Phase drill-down view with plan cards, context summary, and research status"
      min_lines: 50
    - path: "packages/dashboard/app/components/dashboard/plan-card.tsx"
      provides: "Individual plan card showing frontmatter summary, wave, task list, and edit button"
      min_lines: 40
    - path: "packages/dashboard/app/components/dashboard/task-list.tsx"
      provides: "Task list with toggleable checkboxes that write back to file"
      min_lines: 40
    - path: "packages/dashboard/app/components/editor/plan-editor.tsx"
      provides: "CodeMirror 6 Markdown editor with oneDark theme and save functionality"
      min_lines: 40
      exports: ["PlanEditor"]
    - path: "packages/dashboard/app/hooks/use-phase-detail.ts"
      provides: "Custom hook that fetches phase detail and individual plan contents"
      min_lines: 25
      exports: ["usePhaseDetail"]
  key_links:
    - from: "packages/dashboard/app/components/editor/plan-editor.tsx"
      to: "@uiw/react-codemirror"
      via: "CodeMirror component import"
      pattern: "import CodeMirror"
    - from: "packages/dashboard/app/components/dashboard/task-list.tsx"
      to: "/api/plan/[...path]"
      via: "PUT fetch on checkbox toggle"
      pattern: "fetch.*api/plan.*PUT"
    - from: "packages/dashboard/app/components/editor/plan-editor.tsx"
      to: "/api/plan/[...path]"
      via: "PUT fetch on save"
      pattern: "fetch.*api/plan.*PUT"
    - from: "packages/dashboard/app/hooks/use-phase-detail.ts"
      to: "/api/phase/[id]"
      via: "fetch() for phase detail"
      pattern: "fetch.*api/phase"
---

<objective>
Build the phase drill-down view with plan cards, task checkboxes, and CodeMirror Markdown editor.

Purpose: Enable the user to see detailed plan information and make inline edits (checkbox toggling, full Markdown editing) directly from the dashboard.
Output: Phase detail view with plan cards showing tasks, toggleable checkboxes that write back to disk, and a CodeMirror editor for full plan Markdown editing.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/13-live-project-dashboard/13-CONTEXT.md
@.planning/phases/13-live-project-dashboard/13-RESEARCH.md
@.planning/phases/13-live-project-dashboard/13-01-SUMMARY.md
@.planning/phases/13-live-project-dashboard/13-02-SUMMARY.md
@.planning/phases/13-live-project-dashboard/13-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePhaseDetail hook, plan card, and task list with checkbox toggling</name>
  <files>
    packages/dashboard/app/hooks/use-phase-detail.ts
    packages/dashboard/app/components/dashboard/plan-card.tsx
    packages/dashboard/app/components/dashboard/task-list.tsx
  </files>
  <action>
  1. **app/hooks/use-phase-detail.ts** — "use client" custom hook:
     - `usePhaseDetail(phaseId: string | null)`: Fetches from `/api/phase/${phaseId}` when phaseId is set
     - Re-fetches on `useWebSocket().lastChange` change
     - Returns: `{ plans, context, research, loading, error, refetch }`
     - Handles null phaseId (returns empty state)

  2. **app/components/dashboard/task-list.tsx** — "use client" component:
     - Props: `tasks: PlanTask[]`, `planPath: string`, `planContent: string`, `onContentChange: (newContent: string) => void`
     - Renders each task as a row: checkbox + task name + type badge + status
     - **Checkbox toggle logic:**
       - On click, toggle the `- [ ]` ↔ `- [x]` in the raw plan content for the matching task
       - Find the task's `<done>` line in the Markdown and toggle the checkbox marker
       - Call `onContentChange(updatedContent)` which triggers an immediate PUT to the API
     - Type badges: `auto` in muted, `checkpoint:*` in warning color
     - Task name in sans font, files in mono font (smaller, muted)
     - Completed tasks get strikethrough text and muted opacity

  3. **app/components/dashboard/plan-card.tsx** — "use client" component:
     - Props: `plan: PlanFile`, `onEdit: (planPath: string) => void`
     - Shows: plan number, wave badge, autonomous badge, objective excerpt
     - Shows task list via `<TaskList>` component
     - "Edit" button that triggers `onEdit(plan.path)` to open CodeMirror editor
     - Frontmatter summary: wave number, depends_on list, files_modified count
     - Card styling: bg-card, border-border, rounded-lg, p-4, hover:bg-card-hover
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx next build 2>&1 | tail -5</automated>
  </verify>
  <done>usePhaseDetail hook fetches phase data and refreshes on file changes; plan card shows frontmatter summary and task list; checkbox toggle modifies raw Markdown and writes back via API</done>
</task>

<task type="auto">
  <name>Task 2: Create CodeMirror plan editor and phase detail container</name>
  <files>
    packages/dashboard/app/components/editor/plan-editor.tsx
    packages/dashboard/app/components/dashboard/phase-detail.tsx
  </files>
  <action>
  1. **app/components/editor/plan-editor.tsx** — "use client" component:
     - Props: `initialContent: string`, `filePath: string`, `onSave: (content: string) => Promise<void>`, `onClose: () => void`
     - Uses `@uiw/react-codemirror` with `markdown({ base: markdownLanguage })` extension and `oneDark` theme
     - Editor height: `calc(100vh - 200px)` for near-full-screen editing
     - Tracks dirty state (content !== initialContent)
     - Save button: appears when dirty, calls `onSave(content)`, resets dirty state
     - Close button: top-right, warns if dirty ("Unsaved changes — discard?")
     - Keyboard shortcut: Ctrl+S / Cmd+S triggers save (prevent default)
     - File path displayed above editor in mono font
     - Import from `@codemirror/lang-markdown` for `markdown` and `markdownLanguage`
     - Import from `@codemirror/theme-one-dark` for dark theme matching dashboard

  2. **app/components/dashboard/phase-detail.tsx** — "use client" component:
     - Props: `phaseId: string`, `onBack: () => void`
     - Uses `usePhaseDetail(phaseId)` hook
     - Layout:
       - Back button (arrow left + "Back to overview") at top
       - Phase header: number + name + status badge + goal text
       - Context/Research indicators: green badges if available, linking to content
       - Plan cards in a vertical list, one per plan
       - When "Edit" clicked on a plan card: show `<PlanEditor>` overlay/panel
     - Edit flow:
       - Fetch full plan content from `/api/plan/${planPath}`
       - Open PlanEditor with content
       - On save: PUT to `/api/plan/${planPath}` with updated content
       - On close: hide editor, refetch phase detail
     - Loading state: skeleton cards
     - Empty state: "No plans yet — run /maxsim:plan-phase to create plans"
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx next build 2>&1 | tail -5</automated>
  </verify>
  <done>CodeMirror editor opens for plan editing with Markdown syntax highlighting and Ctrl+S save; phase detail view shows all plans with tasks, supports checkbox toggling and full editor; back navigation works</done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds with CodeMirror and all dashboard components
2. PlanEditor renders CodeMirror with oneDark theme and Markdown highlighting
3. Task checkboxes toggle and write updated content back to file via API
4. Phase detail fetches and renders all plan cards with frontmatter summary
5. Editor Ctrl+S shortcut triggers save
</verification>

<success_criteria>
- Phase drill-down shows all plans with task checkboxes
- Checkbox toggling writes changes immediately to PLAN.md files
- CodeMirror editor opens with Markdown syntax highlighting on dark theme
- Save button writes content back via PUT API
- Back navigation returns to phase overview
</success_criteria>

<output>
After completion, create `.planning/phases/13-live-project-dashboard/13-05-SUMMARY.md`
</output>
