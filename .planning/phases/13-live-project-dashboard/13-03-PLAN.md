---
phase: 13-live-project-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - packages/dashboard/lib/parsers.ts
  - packages/dashboard/app/api/roadmap/route.ts
  - packages/dashboard/app/api/state/route.ts
  - packages/dashboard/app/api/phases/route.ts
  - packages/dashboard/app/api/phase/[id]/route.ts
  - packages/dashboard/app/api/plan/[...path]/route.ts
  - packages/dashboard/app/api/todos/route.ts
  - packages/dashboard/app/api/project/route.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "API routes read and parse all .planning/ files via @maxsim/core internal helpers"
    - "GET /api/roadmap returns structured JSON with all phases, progress, milestones"
    - "GET /api/state returns parsed STATE.md data (position, decisions, blockers, metrics)"
    - "GET /api/phases returns list of phases with plan counts, summary counts, disk status"
    - "GET /api/phase/[id] returns phase detail with plan files, tasks, context"
    - "GET /api/plan/[...path] returns plan file content; PUT writes it back"
    - "GET /api/todos returns pending and completed todos"
    - "GET /api/project returns PROJECT.md and REQUIREMENTS.md content"
  artifacts:
    - path: "packages/dashboard/lib/parsers.ts"
      provides: "Wrapper functions that call @maxsim/core parsing logic and return data objects (not stdout)"
      min_lines: 80
      exports: ["parseRoadmap", "parseState", "parsePhases", "parsePhaseDetail", "parseTodos", "parseProject"]
    - path: "packages/dashboard/app/api/roadmap/route.ts"
      provides: "GET endpoint for roadmap analysis"
      exports: ["GET"]
    - path: "packages/dashboard/app/api/state/route.ts"
      provides: "GET endpoint for state data, PATCH for updates"
      exports: ["GET", "PATCH"]
    - path: "packages/dashboard/app/api/phases/route.ts"
      provides: "GET endpoint for phases list with progress"
      exports: ["GET"]
    - path: "packages/dashboard/app/api/phase/[id]/route.ts"
      provides: "GET endpoint for individual phase detail"
      exports: ["GET"]
    - path: "packages/dashboard/app/api/plan/[...path]/route.ts"
      provides: "GET/PUT endpoints for plan file read/write"
      exports: ["GET", "PUT"]
    - path: "packages/dashboard/app/api/todos/route.ts"
      provides: "GET endpoint for todos; POST for new todo; PATCH for completion"
      exports: ["GET", "POST", "PATCH"]
    - path: "packages/dashboard/app/api/project/route.ts"
      provides: "GET endpoint for project and requirements data"
      exports: ["GET"]
  key_links:
    - from: "packages/dashboard/lib/parsers.ts"
      to: "@maxsim/core"
      via: "import internal helpers"
      pattern: "import.*from.*@maxsim/core"
    - from: "packages/dashboard/app/api/roadmap/route.ts"
      to: "packages/dashboard/lib/parsers.ts"
      via: "parseRoadmap() call"
      pattern: "parseRoadmap"
    - from: "packages/dashboard/app/api/plan/[...path]/route.ts"
      to: "packages/dashboard/lib/watcher.ts"
      via: "suppressPath() before write"
      pattern: "suppressPath"
---

<objective>
Build the data layer: parsing wrappers around @maxsim/core and all Next.js API routes for reading and writing .planning/ files.

Purpose: Create the backend data access layer that reads .planning/ files using @maxsim/core's existing parsing logic and exposes structured JSON via API routes -- bridging the CLI-oriented core library to the web dashboard.
Output: A lib/parsers.ts module with non-printing data functions, and 7 API route handlers covering roadmap, state, phases, plans, todos, and project data.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-live-project-dashboard/13-CONTEXT.md
@.planning/phases/13-live-project-dashboard/13-RESEARCH.md
@.planning/phases/13-live-project-dashboard/13-01-SUMMARY.md
@packages/core/src/index.ts
@packages/core/src/roadmap.ts
@packages/core/src/state.ts
@packages/core/src/commands.ts
@packages/core/src/phase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/parsers.ts with @maxsim/core wrapper functions</name>
  <files>
    packages/dashboard/lib/parsers.ts
  </files>
  <action>
  Create wrapper functions that re-implement the key data extraction logic from `@maxsim/core` WITHOUT calling `output()` (which calls `process.exit()`). Import the internal helpers directly:

  **CRITICAL:** The core cmd* functions call `output()` which calls `process.exit(0)`. The dashboard CANNOT call these. Instead, use the exported internal helpers and re-implement just the data assembly:

  1. **`parseRoadmap(cwd: string): RoadmapAnalysis | null`**
     - Read `.planning/ROADMAP.md` directly with `fs.readFileSync`
     - Use `getPhasePattern()`, `normalizePhaseName()` from `@maxsim/core`
     - Re-implement the phase parsing loop from `cmdRoadmapAnalyze` (it builds a `RoadmapAnalysis` object before passing to `output()` — replicate that logic, return the object)
     - Include: milestones, phases with disk_status, progress_percent, current_phase, next_phase

  2. **`parseState(cwd: string): StateData | null`**
     - Read `.planning/STATE.md` directly
     - Use `stateExtractField()` from `@maxsim/core` to extract sections
     - Return parsed state data: position, last_activity, decisions, blockers, metrics, todos

  3. **`parsePhases(cwd: string): DashboardPhase[]`**
     - Read phases directory, count plans/summaries per phase
     - Use `normalizePhaseName()`, `comparePhaseNum()` for sorting

  4. **`parsePhaseDetail(cwd: string, phaseId: string): { plans: PlanFile[], context: string | null, research: string | null }`**
     - Read all PLAN.md files in the phase directory
     - Use `extractFrontmatter()` to parse frontmatter from each plan
     - Parse task XML from plan content to extract task list
     - Return structured plan objects with frontmatter and tasks

  5. **`parseTodos(cwd: string): { pending: TodoItem[], completed: TodoItem[] }`**
     - Read `.planning/todos/pending/` and `.planning/todos/completed/` directories
     - Return arrays of todo items

  6. **`parseProject(cwd: string): { project: string | null, requirements: string | null }`**
     - Read PROJECT.md and REQUIREMENTS.md as raw strings

  All functions: Return null or empty arrays if files don't exist (not errors). Use `fs.existsSync` guards. Env var `MAXSIM_PROJECT_CWD` takes precedence over `process.cwd()`.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx tsc --noEmit 2>&1 | tail -10</automated>
  </verify>
  <done>lib/parsers.ts exports 6 parsing functions that return data objects without calling process.exit(), correctly importing internal helpers from @maxsim/core</done>
</task>

<task type="auto">
  <name>Task 2a: Create read-only API route handlers</name>
  <files>
    packages/dashboard/app/api/roadmap/route.ts
    packages/dashboard/app/api/phases/route.ts
    packages/dashboard/app/api/phase/[id]/route.ts
    packages/dashboard/app/api/project/route.ts
  </files>
  <action>
  Create Next.js App Router read-only API route handlers that use `lib/parsers.ts`:

  **All routes:** Read `MAXSIM_PROJECT_CWD` env var or fall back to `process.cwd()`.

  1. **app/api/roadmap/route.ts** — `GET`:
     - Call `parseRoadmap(cwd)` and return JSON
     - Return 404 if null

  2. **app/api/phases/route.ts** — `GET`:
     - Call `parsePhases(cwd)` and return JSON array

  3. **app/api/phase/[id]/route.ts** — `GET`:
     - Extract phase ID from params
     - Call `parsePhaseDetail(cwd, phaseId)` and return JSON
     - Return 404 if phase directory not found

  4. **app/api/project/route.ts** — `GET`:
     - Call `parseProject(cwd)` and return JSON

  **Security:** All file operations validate paths are within `.planning/` using `path.resolve()` check.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx tsc --noEmit 2>&1 | tail -10</automated>
  </verify>
  <done>4 read-only API route files exist and compile, each handler calls parsers.ts functions and returns JSON responses</done>
</task>

<task type="auto">
  <name>Task 2b: Create write/mutation API route handlers</name>
  <files>
    packages/dashboard/app/api/state/route.ts
    packages/dashboard/app/api/plan/[...path]/route.ts
    packages/dashboard/app/api/todos/route.ts
  </files>
  <action>
  Create Next.js App Router API route handlers with write/mutation support:

  **All routes:** Read `MAXSIM_PROJECT_CWD` env var or fall back to `process.cwd()`.

  1. **app/api/state/route.ts** — `GET` + `PATCH`:
     - GET: Call `parseState(cwd)` and return JSON
     - PATCH: Accept `{ field, value }` body, use `stateReplaceField()` from @maxsim/core to update STATE.md, call `suppressPath()` from watcher before writing

  2. **app/api/plan/[...path]/route.ts** — `GET` + `PUT`:
     - GET: Read file content at `.planning/{path segments joined}`
     - PUT: Accept `{ content }` body, write file, call `suppressPath()` from watcher before writing
     - Validate path stays within `.planning/` (security: no path traversal)

  3. **app/api/todos/route.ts** — `GET` + `POST` + `PATCH`:
     - GET: Call `parseTodos(cwd)` and return JSON
     - POST: Accept `{ text }`, create new todo file in `.planning/todos/pending/`
     - PATCH: Accept `{ file, completed }`, move todo between pending/completed, call `suppressPath()` before writing

  **Security:** All file operations validate paths are within `.planning/` using `path.resolve()` check. Write operations call `suppressPath()` to prevent watcher broadcast loops.
  </action>
  <verify>
    <automated>cd C:/Development/cli/maxsim/packages/dashboard && npx next build 2>&1 | tail -5</automated>
  </verify>
  <done>3 write/mutation API route files exist and compile, each handler calls parsers.ts functions and returns JSON responses, write operations call suppressPath() before writing</done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds with all API routes
2. `npx tsc --noEmit` passes for lib/parsers.ts and all route files
3. parsers.ts does NOT import or call any cmd* function that calls output()/process.exit()
4. Write operations in plan and state routes call suppressPath() to prevent watcher broadcast loops
5. Path traversal prevention validates all file paths stay within .planning/
</verification>

<success_criteria>
- lib/parsers.ts provides 6 data-returning functions wrapping @maxsim/core logic
- 7 API routes handle all read/write operations for dashboard data
- No process.exit() calls leak into the dashboard server
- Write operations suppress watcher events to prevent broadcast loops
- All files compile and next build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/13-live-project-dashboard/13-03-SUMMARY.md`
</output>
