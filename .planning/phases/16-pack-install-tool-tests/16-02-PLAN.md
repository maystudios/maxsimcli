---
phase: 16-pack-install-tool-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/e2e/src/globalSetup.ts
  - packages/e2e/src/fixtures/mock-project.ts
autonomous: true
requirements: [E2E-02, TOOL-06]

must_haves:
  truths:
    - "globalSetup runs npm pack from packages/cli (not packages/cli/dist), installs via tarball to mkdtempSync dir, and runs maxsimcli --claude --local — no registry contact"
    - "globalSetup exposes installDir, tarballPath, and toolsPath via context.provide() so test files can access them via inject()"
    - "createMockProject() creates a temp dir with .planning/ structure including ROADMAP.md, STATE.md, PROJECT.md, todos, and a phase dir with PLAN.md"
    - "mock project STATE.md includes the Blockers/Concerns section so state add-blocker can succeed"
  artifacts:
    - path: "packages/e2e/src/globalSetup.ts"
      provides: "Vitest globalSetup: pack + install + MAXSIM install; provides installDir, toolsPath, tarballPath"
      exports: ["setup"]
    - path: "packages/e2e/src/fixtures/mock-project.ts"
      provides: "createMockProject() factory — creates realistic .planning/ structure in temp dir"
      exports: ["createMockProject", "MockProject"]
  key_links:
    - from: "packages/e2e/src/globalSetup.ts"
      to: "packages/cli"
      via: "npm pack in cliDir"
      pattern: "execSync.*npm pack"
    - from: "packages/e2e/src/globalSetup.ts"
      to: "installDir/.claude/maxsim/bin/maxsim-tools.cjs"
      via: "context.provide('toolsPath', ...)"
      pattern: "provide.*toolsPath"
    - from: "packages/e2e/src/fixtures/mock-project.ts"
      to: ".planning/STATE.md"
      via: "writeFileSync with Blockers/Concerns section"
      pattern: "Blockers/Concerns"
---

<objective>
Implement the globalSetup pack+install pipeline and the mock project fixture factory.

Purpose: globalSetup (E2E-02) is the shared infrastructure that all E2E tests depend on — it runs once, packs the CLI into a tarball, installs it locally, and runs the MAXSIM installer. The mock project fixture (TOOL-06) is the shared test helper that behavioral tests use to avoid re-creating project structures per test.
Output: packages/e2e/src/globalSetup.ts and packages/e2e/src/fixtures/mock-project.ts
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-pack-install-tool-tests/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create globalSetup.ts — pack, install, provide</name>
  <files>packages/e2e/src/globalSetup.ts</files>
  <action>
Create `packages/e2e/src/globalSetup.ts` with the following implementation.

Key constraints (from RESEARCH.md pitfall list):
- Use `npm pack` (NOT `pnpm pack`) — validates npm consumer experience
- Run npm pack with `cwd: packages/cli` (NOT `packages/cli/dist`) — package.json is at the package root
- Use `npm install "${tarballPath}"` with double-quoted path to handle Windows backslashes
- Run MAXSIM installer with `--claude --local` (NOT `--global`) — local install writes to `installDir/.claude/`, not `~/.claude/`
- toolsPath is `installDir/.claude/maxsim/bin/maxsim-tools.cjs` (verified install location)

```typescript
import { execSync } from 'node:child_process';
import { mkdtempSync, mkdirSync, writeFileSync, rmSync } from 'node:fs';
import { join } from 'node:path';
import { tmpdir } from 'node:os';

// Vitest 4 globalSetup: export setup(context) function
export async function setup(context: { provide: (key: string, value: unknown) => void }) {
  // Resolve packages/cli directory using process.cwd() — Vitest sets cwd to packages/e2e
  const cliDir = join(process.cwd(), '..', 'cli');

  // Step 1: npm pack from packages/cli
  const packOutput = execSync('npm pack', {
    cwd: cliDir,
    encoding: 'utf8',
    timeout: 60_000,
  });
  const tarballName = packOutput.trim().split('\n').pop()!;
  const tarballPath = join(cliDir, tarballName);

  // Step 2: Create temp dir and install tarball
  const installDir = mkdtempSync(join(tmpdir(), 'maxsim-e2e-'));
  writeFileSync(join(installDir, 'package.json'), '{}');
  execSync(`npm install "${tarballPath}"`, {
    cwd: installDir,
    timeout: 120_000,
    stdio: 'pipe',
  });

  // Step 3: Run maxsimcli --claude --local to install MAXSIM files into installDir/.claude/
  const installCjs = join(installDir, 'node_modules', 'maxsimcli', 'dist', 'install.cjs');
  execSync(`node "${installCjs}" --claude --local`, {
    cwd: installDir,
    timeout: 30_000,
    stdio: 'pipe',
  });

  // Step 4: Expose paths to test files via provide()
  const toolsPath = join(installDir, '.claude', 'maxsim', 'bin', 'maxsim-tools.cjs');
  context.provide('installDir', installDir);
  context.provide('tarballPath', tarballPath);
  context.provide('toolsPath', toolsPath);

  // Return teardown function — Vitest calls this after all tests complete
  return () => {
    rmSync(installDir, { recursive: true, force: true });
    rmSync(tarballPath, { force: true });
  };
}
```

Note on path resolution: `process.cwd()` is used because Vitest sets the working directory to the package root (`packages/e2e`) when running globalSetup. `join(process.cwd(), '..', 'cli')` therefore resolves to `packages/cli` — one step up from `packages/e2e` and then into `cli`.
  </action>
  <verify>
    <automated>ls packages/e2e/src/globalSetup.ts && echo "globalSetup.ts created"</automated>
  </verify>
  <done>`packages/e2e/src/globalSetup.ts` exists, exports a `setup` function, uses npm pack + npm install + node install.cjs --claude --local pattern, and calls context.provide() for installDir, toolsPath, tarballPath. The teardown function calls rmSync with force:true.</done>
</task>

<task type="auto">
  <name>Task 2: Create mock-project.ts fixture factory</name>
  <files>packages/e2e/src/fixtures/mock-project.ts</files>
  <action>
Create `packages/e2e/src/fixtures/mock-project.ts` with the `createMockProject()` factory function.

The mock project must include:
1. `.planning/phases/` directory (empty initially — phase dir added below)
2. `.planning/todos/pending/` and `.planning/todos/completed/` directories
3. `.planning/ROADMAP.md` — two phases in standard format
4. `.planning/STATE.md` — with Decisions AND Blockers/Concerns sections (CRITICAL: state add-blocker requires Blockers/Concerns section to exist or it returns `added: false`)
5. `.planning/PROJECT.md` — minimal project description
6. A phase directory `.planning/phases/01-foundation/` with a PLAN.md
7. A pending todo file `todos/pending/todo-001-test-task.md`

```typescript
import { mkdtempSync, mkdirSync, writeFileSync, rmSync } from 'node:fs';
import { join } from 'node:path';
import { tmpdir } from 'node:os';

export interface MockProject {
  dir: string;
  cleanup: () => void;
}

export function createMockProject(): MockProject {
  const dir = mkdtempSync(join(tmpdir(), 'maxsim-mock-'));

  // Directory structure
  mkdirSync(join(dir, '.planning', 'phases', '01-foundation'), { recursive: true });
  mkdirSync(join(dir, '.planning', 'todos', 'pending'), { recursive: true });
  mkdirSync(join(dir, '.planning', 'todos', 'completed'), { recursive: true });

  // ROADMAP.md — 2 phases with proper ## Phases section
  writeFileSync(join(dir, '.planning', 'ROADMAP.md'), [
    '# Roadmap: Mock Project v1.0',
    '',
    '## Overview',
    '',
    'A mock project for E2E testing.',
    '',
    '## Phases',
    '',
    '- [ ] **Phase 01: Foundation** - Build core',
    '- [ ] **Phase 02: Integration** - Wire it together',
    '',
    '## Phase Details',
    '',
    '### Phase 01: Foundation',
    '**Goal**: Build the core',
    '**Depends on**: Nothing',
    '**Requirements**: MOCK-01',
    '**Plans**: 1 plan',
    '',
    'Plans:',
    '- [ ] 01-01-PLAN.md — Foundation tasks',
    '',
    '### Phase 02: Integration',
    '**Goal**: Wire it together',
    '**Depends on**: Phase 01',
    '**Requirements**: MOCK-02',
    '**Plans**: TBD',
  ].join('\n'));

  // STATE.md — must include Blockers/Concerns section for state add-blocker to work
  writeFileSync(join(dir, '.planning', 'STATE.md'), [
    '# Project State',
    '',
    '## Current Position',
    '',
    'Phase: 01',
    'Status: In progress',
    '',
    '## Accumulated Context',
    '',
    '### Decisions',
    '',
    '- [Init]: Mock decision one — for testing purposes',
    '',
    '### Blockers/Concerns',
    '',
    '### Pending Todos',
    '',
    'None yet.',
  ].join('\n'));

  // PROJECT.md
  writeFileSync(join(dir, '.planning', 'PROJECT.md'), [
    '# Mock Test Project',
    '',
    '## What This Is',
    '',
    'A mock project for E2E testing of maxsim-tools.',
    '',
    '## Core Value',
    '',
    'Validates maxsim-tools behavioral tests end-to-end.',
    '',
    '## Key Decisions',
    '',
    '| Decision | Rationale |',
    '|----------|-----------|',
    '| Use mocks | Speed and isolation |',
  ].join('\n'));

  // Phase 01-01 PLAN.md
  writeFileSync(
    join(dir, '.planning', 'phases', '01-foundation', '01-01-PLAN.md'),
    [
      '# Phase 01 Plan 01',
      '',
      '## Tasks',
      '',
      '- [ ] Task one: do the first thing',
      '- [ ] Task two: do the second thing',
    ].join('\n')
  );

  // Pending todo file
  writeFileSync(
    join(dir, '.planning', 'todos', 'pending', 'todo-001-test-task.md'),
    [
      '# Todo: Test Task',
      '',
      '**Area:** general',
      '',
      'Do the test task for E2E validation.',
    ].join('\n')
  );

  return {
    dir,
    cleanup: () => rmSync(dir, { recursive: true, force: true }),
  };
}
```

Create the `src/fixtures/` directory before writing the file:
```bash
mkdir -p packages/e2e/src/fixtures
```
  </action>
  <verify>
    <automated>node -e "const { createMockProject } = require('./packages/e2e/src/fixtures/mock-project.ts'); console.log('ok')" 2>&1 || node --input-type=module --eval "import { createMockProject } from './packages/e2e/src/fixtures/mock-project.ts'; console.log('ok')" 2>&1 || echo "File exists check:" && ls C:/Development/cli/maxsim/packages/e2e/src/fixtures/mock-project.ts</automated>
  </verify>
  <done>`packages/e2e/src/fixtures/mock-project.ts` exists and exports `createMockProject` and `MockProject`. The mock includes ROADMAP.md with 2 phases, STATE.md with Decisions and Blockers/Concerns sections, PROJECT.md, a phase directory with PLAN.md, and a pending todo file.</done>
</task>

</tasks>

<verification>
1. `packages/e2e/src/globalSetup.ts` exists and exports `setup(context)` function
2. globalSetup uses `npm pack` (not pnpm pack), installs via tarball, runs `--claude --local`
3. `packages/e2e/src/fixtures/mock-project.ts` exists and exports `createMockProject`
4. Mock STATE.md contains `### Blockers/Concerns` section
5. Mock has todo file in `todos/pending/`
</verification>

<success_criteria>
- globalSetup.ts provides the complete pack+install pipeline in a single `setup(context)` export
- Mock fixture creates all required .planning/ structure for behavioral tests
- No external dependencies added — only Node.js built-ins and node:child_process
</success_criteria>

<output>
After completion, create `.planning/phases/16-pack-install-tool-tests/16-02-SUMMARY.md`
</output>
