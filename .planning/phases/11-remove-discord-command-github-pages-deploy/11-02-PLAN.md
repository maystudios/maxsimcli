---
phase: 11-remove-discord-command-github-pages-deploy
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/website/project.json
  - packages/website/public/CNAME
  - .github/workflows/deploy-website.yml
autonomous: true
requirements:
  - WEBSITE-DEPLOY-01
  - WEBSITE-DEPLOY-02
  - WEBSITE-DEPLOY-03

must_haves:
  truths:
    - "`nx build website` succeeds and outputs to packages/website/dist/"
    - "The GitHub Actions workflow file exists at .github/workflows/deploy-website.yml"
    - "The workflow triggers on push to main only and deploys using the official GitHub Pages action"
    - "A CNAME file containing maxsimcli.dev is included in the build output"
    - "The workflow has correct permissions: pages write, id-token write, contents read"
  artifacts:
    - path: "packages/website/project.json"
      provides: "NX build target pointing to vite build command"
      contains: "build"
    - path: "packages/website/public/CNAME"
      provides: "Custom domain declaration for GitHub Pages"
      contains: "maxsimcli.dev"
    - path: ".github/workflows/deploy-website.yml"
      provides: "GitHub Actions workflow for build and deploy"
      contains: "actions/deploy-pages"
  key_links:
    - from: ".github/workflows/deploy-website.yml"
      to: "packages/website/dist/"
      via: "nx build website writes to dist/, actions/upload-pages-artifact reads from dist/"
      pattern: "path.*packages/website/dist"
    - from: "packages/website/public/CNAME"
      to: "packages/website/dist/CNAME"
      via: "Vite copies public/ directory contents into dist/ during build"
      pattern: "maxsimcli.dev"
    - from: "packages/website/project.json"
      to: "nx build website"
      via: "NX reads project.json build target; executor runs vite build command"
      pattern: "tsc -b tsconfig.app.json && vite build"
---

<objective>
Set up GitHub Pages deployment for the `packages/website` package by: adding an NX `project.json` so `nx build website` works, placing a `CNAME` file in the Vite `public/` directory for the `maxsimcli.dev` custom domain, and creating a GitHub Actions workflow that builds and deploys on push to main.

Purpose: The website needs automated deployment — currently there is no CI/CD for it. The official GitHub Pages deploy approach (upload-pages-artifact + deploy-pages) avoids orphan branches and is the recommended modern method.
Output: `packages/website/project.json`, `packages/website/public/CNAME`, `.github/workflows/deploy-website.yml`
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-remove-discord-command-github-pages-deploy/11-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NX project.json and CNAME to website package</name>
  <files>
    packages/website/project.json
    packages/website/public/CNAME
  </files>
  <action>
    **1. Create `packages/website/project.json`**

    The website uses Vite (not tsdown), so the `@nx/js/typescript` plugin that auto-configures build targets for tsdown packages does NOT apply here. A manual `project.json` is required.

    The build script in `packages/website/package.json` is: `tsc -b tsconfig.app.json && vite build`
    The output directory is `packages/website/dist/` (Vite default, confirmed in vite.config.ts).

    Create `packages/website/project.json` with this exact content:
    ```json
    {
      "$schema": "../../node_modules/nx/schemas/project-schema.json",
      "name": "website",
      "root": "packages/website",
      "targets": {
        "build": {
          "executor": "nx:run-commands",
          "options": {
            "command": "pnpm run build",
            "cwd": "packages/website"
          },
          "outputs": ["{projectRoot}/dist"]
        }
      }
    }
    ```

    This uses `pnpm run build` (which runs `tsc -b tsconfig.app.json && vite build`) rather than calling the compiler directly, keeping it consistent with the package.json scripts.

    **2. Create `packages/website/public/CNAME`**

    Vite copies all files from `public/` into the `dist/` root during build. A `CNAME` file in `public/` will appear as `dist/CNAME` after build — this is the standard mechanism for GitHub Pages custom domains.

    Create the directory `packages/website/public/` and create `packages/website/public/CNAME` with this exact content (single line, no trailing newline):
    ```
    maxsimcli.dev
    ```

    After creating both files, run `npx nx build website` from the workspace root to confirm the build succeeds and that `packages/website/dist/CNAME` exists.
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); const pj=JSON.parse(fs.readFileSync('packages/website/project.json','utf8')); console.log(pj.name === 'website' && pj.targets?.build ? 'PASS: project.json valid' : 'FAIL: project.json invalid')"</automated>
  </verify>
  <done>
    - `packages/website/project.json` exists with `name: "website"` and a `build` target using `pnpm run build`
    - `packages/website/public/CNAME` exists containing `maxsimcli.dev`
    - `npx nx build website` completes without error
    - `packages/website/dist/CNAME` contains `maxsimcli.dev` (Vite copied it from public/)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deploy-website.yml GitHub Actions workflow</name>
  <files>.github/workflows/deploy-website.yml</files>
  <action>
    Create `.github/workflows/deploy-website.yml` with this content.

    Key constraints from CONTEXT.md (all locked decisions):
    - Trigger: `push to main` ONLY — no `workflow_dispatch`, no PR previews
    - Build command: `npx nx build website` — uses NX for caching consistency
    - Deploy strategy: `actions/upload-pages-artifact` + `actions/deploy-pages` — no gh-pages branch
    - Permissions: `pages: write`, `id-token: write`, `contents: read`
    - Artifact path: `packages/website/dist/` — Vite output directory

    Reference the existing `publish.yml` for node/pnpm version consistency:
    - Node version: `22` (matching publish.yml)
    - pnpm: `pnpm/action-setup@v4` (matching publish.yml)

    The workflow must use two jobs: `build` (runs the vite build) and `deploy` (deploys to Pages). This is the required pattern for `actions/deploy-pages` — the deploy job needs a `needs: build` dependency and the `environment` block.

    Create the file with this exact content:

    ```yaml
    name: Deploy Website to GitHub Pages

    on:
      push:
        branches: [main]

    permissions:
      contents: read
      pages: write
      id-token: write

    concurrency:
      group: pages
      cancel-in-progress: false

    jobs:
      build:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - uses: pnpm/action-setup@v4

          - uses: actions/setup-node@v4
            with:
              node-version: 22
              cache: pnpm

          - name: Install dependencies
            run: pnpm install --frozen-lockfile

          - name: Build website
            run: npx nx build website

          - name: Upload Pages artifact
            uses: actions/upload-pages-artifact@v3
            with:
              path: packages/website/dist

      deploy:
        environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        steps:
          - name: Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4
    ```

    Notes:
    - `cache: pnpm` on setup-node enables pnpm store caching for faster CI runs
    - `cancel-in-progress: false` on the concurrency group prevents a mid-deploy cancellation that would leave the site in a broken state (same pattern as publish.yml)
    - `actions/upload-pages-artifact@v3` and `actions/deploy-pages@v4` are the current stable versions as of early 2026
    - The `pages` concurrency group name is the GitHub-recommended name and prevents concurrent deployments

    After writing the file, validate YAML syntax:
    ```bash
    node -e "const yaml=require('yaml'); yaml.parse(require('fs').readFileSync('.github/workflows/deploy-website.yml','utf8')); console.log('YAML valid')" 2>/dev/null || python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-website.yml')); print('YAML valid')" 2>/dev/null || echo "manual yaml check required"
    ```
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); const c=fs.readFileSync('.github/workflows/deploy-website.yml','utf8'); const checks=['push','branches: [main]','pages: write','id-token: write','contents: read','upload-pages-artifact','deploy-pages','packages/website/dist','npx nx build website','needs: build']; const missing=checks.filter(s=>!c.includes(s)); console.log(missing.length===0?'PASS: workflow valid':'FAIL: missing: '+missing.join(', '))"</automated>
  </verify>
  <done>
    - `.github/workflows/deploy-website.yml` exists
    - Triggers on `push` to `main` only (no workflow_dispatch)
    - Two jobs: `build` (nx build website + upload artifact) and `deploy` (deploy-pages, needs build)
    - Permissions include `pages: write`, `id-token: write`, `contents: read`
    - Artifact path is `packages/website/dist`
    - Uses `pnpm/action-setup@v4` and `node-version: 22` consistent with publish.yml
  </done>
</task>

</tasks>

<verification>
Run these checks after both tasks complete:

1. project.json exists: `cat packages/website/project.json` shows `"name": "website"` with build target
2. CNAME exists: `cat packages/website/public/CNAME` outputs `maxsimcli.dev`
3. NX build works: `npx nx build website` exits 0 and `packages/website/dist/CNAME` exists
4. Workflow exists: `cat .github/workflows/deploy-website.yml` shows both build and deploy jobs
5. Workflow content check: workflow references `upload-pages-artifact`, `deploy-pages`, `packages/website/dist`, and `push: branches: [main]`
</verification>

<success_criteria>
- `packages/website/project.json` exists with `build` target running `pnpm run build`
- `packages/website/public/CNAME` contains `maxsimcli.dev`
- `npx nx build website` succeeds; `packages/website/dist/CNAME` contains `maxsimcli.dev`
- `.github/workflows/deploy-website.yml` exists with push-to-main trigger, upload-pages-artifact + deploy-pages jobs, and correct permissions
</success_criteria>

<output>
After completion, create `.planning/phases/11-remove-discord-command-github-pages-deploy/11-02-SUMMARY.md`
</output>
