---
phase: 14-dashboard-npm-delivery
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - .github/workflows/publish.yml
  - README.md
autonomous: false
requirements:
  - DASH-08
  - DASH-09

must_haves:
  truths:
    - "CI publish workflow builds dashboard standalone before CLI build"
    - "npm pack --dry-run shows dashboard files in dist/assets/dashboard/"
    - "README documents the npx maxsimcli dashboard command"
  artifacts:
    - path: ".github/workflows/publish.yml"
      provides: "STANDALONE_BUILD=true env var for dashboard build in CI"
      contains: "STANDALONE_BUILD"
    - path: "README.md"
      provides: "Dashboard launch documentation"
      contains: "maxsimcli dashboard"
  key_links:
    - from: ".github/workflows/publish.yml"
      to: "packages/dashboard/project.json"
      via: "nx build triggers dashboard build:standalone via implicit dependency"
      pattern: "STANDALONE_BUILD"
---

<objective>
Ensure the CI publish workflow correctly builds the dashboard in standalone mode before the CLI build, validate the npm tarball contains the dashboard, and document the dashboard command in the README.

Purpose: Without CI configuration, the published npm package would not contain the dashboard. Without validation, we cannot be sure the tarball size is acceptable. Without README docs, users would not know `npx maxsimcli dashboard` exists.

Output: Working CI pipeline that publishes dashboard inside maxsimcli, validated tarball size, and user-facing documentation.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-npm-delivery/14-CONTEXT.md
@.planning/phases/14-dashboard-npm-delivery/14-RESEARCH.md
@.planning/phases/14-dashboard-npm-delivery/14-01-SUMMARY.md
@.planning/phases/14-dashboard-npm-delivery/14-02-SUMMARY.md
@.github/workflows/publish.yml
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CI publish workflow for standalone dashboard build and validate tarball</name>
  <files>
    .github/workflows/publish.yml
  </files>
  <action>
  1. Update `.github/workflows/publish.yml`:
     - The existing workflow runs `pnpm run build` which calls `nx run-many --target=build`
     - Since Plan 02 added `dashboard` to CLI's implicitDependencies, `nx build cli` already triggers `nx build dashboard` first
     - The dashboard project.json build target (updated in Plan 01) uses `build:standalone` which requires `STANDALONE_BUILD=true`
     - Add the `STANDALONE_BUILD` env var to the Build step:
       ```yaml
       - name: Build
         run: pnpm run build
         env:
           STANDALONE_BUILD: 'true'
       ```
     - This ensures the standalone build runs in CI (Ubuntu) where symlinks work fine, avoiding the Windows EPERM issue

  2. Add a tarball size check step after Build but before Push:
     ```yaml
     - name: Validate tarball
       run: |
         cd packages/cli
         SIZE=$(pnpm pack --dry-run 2>&1 | tail -1)
         echo "Tarball size: $SIZE"
         # Check dashboard files are included
         pnpm pack --dry-run 2>&1 | grep -q "dist/assets/dashboard/server.js" || echo "WARNING: dashboard server.js not in tarball"
         pnpm pack --dry-run 2>&1 | grep -q "dist/assets/dashboard/.next" || echo "WARNING: dashboard .next not in tarball"
     ```
     This validates that the dashboard files are actually included in the tarball and logs the size for monitoring.

  NOTE: The Build step already happens before Push/Publish. The NX dependency graph ensures dashboard builds before CLI. No reordering of existing steps needed — just the env var addition and validation step.
  </action>
  <verify>
    <automated>cd /d C:\Development\cli\maxsim && node -e "const yml=require('fs').readFileSync('.github/workflows/publish.yml','utf-8');console.log('has STANDALONE_BUILD:', yml.includes('STANDALONE_BUILD'));console.log('has tarball validation:', yml.includes('tarball') || yml.includes('pack'))"</automated>
    publish.yml has STANDALONE_BUILD env var on Build step.
    publish.yml has tarball validation step.
  </verify>
  <done>
    CI Build step runs with STANDALONE_BUILD=true, ensuring dashboard produces standalone output.
    Tarball validation step checks for dashboard files in the packaged output.
    NX implicit dependency ensures correct build order (dashboard before CLI).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dashboard section to README</name>
  <files>
    README.md
  </files>
  <action>
  1. Read the existing README.md to understand its structure
  2. Add a "Live Dashboard" section (if not already present from Phase 13) or update the existing one:
     - After the main install/usage section, add:
       ```markdown
       ## Live Dashboard

       MAXSIM includes a real-time web dashboard that shows phase progress, open tasks, blockers,
       and allows inline plan editing.

       ```bash
       npx maxsimcli dashboard
       ```

       The dashboard auto-detects a free port starting from 3333 and opens your browser.
       It watches `.planning/` for changes and updates in real-time via WebSocket.

       - **Auto-installed** during `npx maxsimcli@latest` — no separate setup needed
       - **Works with both global and local installs**
       - **Auto-opens browser** on launch
       - **Detects running instances** — won't start a duplicate server
       ```
  3. If the README already has a dashboard section that says "requires monorepo" or "development only", update it to reflect that the dashboard is now shipped with the npm package.
  </action>
  <verify>
    <automated>cd /d C:\Development\cli\maxsim && node -e "const r=require('fs').readFileSync('README.md','utf-8');console.log('has dashboard section:', r.includes('maxsimcli dashboard'));console.log('has auto-installed mention:', r.includes('Auto-installed') || r.includes('auto-install'))"</automated>
    README.md documents `npx maxsimcli dashboard` command.
    README.md mentions auto-install behavior.
  </verify>
  <done>
    README documents the dashboard launch command.
    README explains auto-install, auto-open, and real-time features.
    No references to "requires monorepo" or "development only" remain.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete dashboard npm delivery pipeline:
  1. Next.js standalone build with env-var guard (Plan 01)
  2. Asset pipeline: copy-assets.cjs copies standalone to dist/assets/dashboard/ (Plan 02)
  3. Install pipeline: install.ts copies to .claude/dashboard/ with dashboard.json (Plan 02)
  4. Launch: npx maxsimcli dashboard spawns node .claude/dashboard/server.js (Plan 02)
  5. CI: publish.yml builds with STANDALONE_BUILD=true (Plan 03)
  6. Docs: README documents the command (Plan 03)
  </what-built>
  <how-to-verify>
  1. Run `nx build cli` from monorepo root — verify it completes without error
     (NOTE: This may fail on Windows due to standalone EPERM — if so, that is expected. The standalone build is designed for CI/Ubuntu. Verify the non-standalone build path works.)
  2. Check `packages/cli/dist/assets/dashboard/` contains server.js and .next/ directory
     (If standalone build succeeded on your machine)
  3. Run `pnpm pack --dry-run` from packages/cli/ and confirm dashboard files are listed
  4. Verify `.github/workflows/publish.yml` has STANDALONE_BUILD env var
  5. Verify README.md has dashboard section
  6. If possible, test `npx maxsimcli dashboard` from a test project
  </how-to-verify>
  <resume-signal>Type "approved" if the pipeline looks correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/publish.yml` Build step has `STANDALONE_BUILD: 'true'` env var
2. Tarball validation step exists in the workflow
3. README.md documents `npx maxsimcli dashboard` with auto-install behavior
4. Full pipeline verified: standalone build -> copy-assets -> install -> launch
</verification>

<success_criteria>
- CI publish workflow builds dashboard with STANDALONE_BUILD=true
- Tarball validation step checks for dashboard files
- README documents dashboard command and auto-install behavior
- Human verification confirms end-to-end pipeline integrity
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-npm-delivery/14-03-SUMMARY.md`
</output>
