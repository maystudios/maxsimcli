---
phase: 14-dashboard-npm-delivery
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - packages/cli/scripts/copy-assets.cjs
  - packages/cli/project.json
  - packages/cli/src/install.ts
  - packages/cli/src/cli.ts
autonomous: true
requirements:
  - DASH-04
  - DASH-05
  - DASH-06
  - DASH-07

must_haves:
  truths:
    - "copy-assets.cjs copies standalone dashboard build into dist/assets/dashboard/"
    - "install.ts copies dashboard from dist/assets/dashboard/ to .claude/dashboard/ (local) or ~/.claude/dashboard/ (global)"
    - "install.ts writes dashboard.json with projectCwd next to dashboard/ directory"
    - "npx maxsimcli dashboard runs node .claude/dashboard/server.js with MAXSIM_PROJECT_CWD"
    - "If .claude/dashboard/ missing when user runs dashboard command, auto-install first then launch"
    - "CLI project.json lists dashboard as implicit dependency"
  artifacts:
    - path: "packages/cli/scripts/copy-assets.cjs"
      provides: "Dashboard standalone build copy into dist/assets/dashboard/"
      contains: "dist/assets/dashboard"
    - path: "packages/cli/project.json"
      provides: "Dashboard as implicit dependency for NX build order"
      contains: "dashboard"
    - path: "packages/cli/src/install.ts"
      provides: "Dashboard install-time copy to .claude/dashboard/ with dashboard.json"
      contains: "dashboard.json"
    - path: "packages/cli/src/cli.ts"
      provides: "Reworked dashboard launch from installed standalone build"
      contains: ".claude/dashboard/server.js"
  key_links:
    - from: "packages/cli/scripts/copy-assets.cjs"
      to: "packages/dashboard/.next/standalone"
      via: "copyDir from standalone build output"
      pattern: "standalone.*dashboard"
    - from: "packages/cli/src/install.ts"
      to: "dist/assets/dashboard"
      via: "path.resolve(__dirname, 'assets', 'dashboard')"
      pattern: "assets.*dashboard"
    - from: "packages/cli/src/cli.ts"
      to: ".claude/dashboard/server.js"
      via: "node server.js with MAXSIM_PROJECT_CWD"
      pattern: "dashboard.*server\\.js"
---

<objective>
Wire the dashboard standalone build into the CLI's asset pipeline (copy-assets.cjs), install flow (install.ts), and launch command (cli.ts) so that the dashboard is automatically copied during install and launchable via `npx maxsimcli dashboard`.

Purpose: This connects the standalone build output from Plan 01 to the end-user experience. Without this, the standalone build exists but never reaches users.

Output: Complete pipeline from standalone build -> dist/assets/dashboard/ -> .claude/dashboard/ -> `node server.js`.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-npm-delivery/14-CONTEXT.md
@.planning/phases/14-dashboard-npm-delivery/14-RESEARCH.md
@.planning/phases/14-dashboard-npm-delivery/14-01-SUMMARY.md
@packages/cli/scripts/copy-assets.cjs
@packages/cli/project.json
@packages/cli/src/install.ts
@packages/cli/src/cli.ts
@packages/cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend copy-assets.cjs for dashboard and add NX implicit dependency</name>
  <files>
    packages/cli/scripts/copy-assets.cjs
    packages/cli/project.json
  </files>
  <action>
  1. Update `packages/cli/scripts/copy-assets.cjs` — add Section 4 after the CHANGELOG copy (Section 3):

     ```javascript
     // 4. Copy dashboard standalone build into dist/assets/dashboard
     const dashboardStandalone = path.join(monorepoRoot, 'packages', 'dashboard', '.next', 'standalone');
     const dashboardStatic = path.join(monorepoRoot, 'packages', 'dashboard', '.next', 'static');
     const dashboardPublic = path.join(monorepoRoot, 'packages', 'dashboard', 'public');
     const dashboardDest = path.join(distAssetsDir, 'dashboard');

     if (fs.existsSync(dashboardStandalone)) {
       // Copy the standalone directory contents (server routes, traced node_modules, .next)
       const standaloneCount = copyDir(dashboardStandalone, dashboardDest);
       console.log(`  [assets] Copied ${standaloneCount} files -> dist/assets/dashboard/`);

       // Copy static assets into the standalone .next/static (required by Next.js)
       if (fs.existsSync(dashboardStatic)) {
         const staticDest = path.join(dashboardDest, '.next', 'static');
         const staticCount = copyDir(dashboardStatic, staticDest);
         console.log(`  [assets] Copied ${staticCount} static files -> dist/assets/dashboard/.next/static/`);
       }

       // Copy public/ assets if they exist
       if (fs.existsSync(dashboardPublic)) {
         const publicDest = path.join(dashboardDest, 'public');
         const publicCount = copyDir(dashboardPublic, publicDest);
         console.log(`  [assets] Copied ${publicCount} public files -> dist/assets/dashboard/public/`);
       }
     } else {
       console.warn('  [warn] Dashboard standalone build not found, skipping. Run STANDALONE_BUILD=true nx build dashboard first.');
     }
     ```

     NOTE: The standalone build's server.js is already in `.next/standalone/server.js` (copied there by the build:standalone script from Plan 01). No need to copy separately.

  2. Update `packages/cli/project.json`:
     - Add `"dashboard"` to the `implicitDependencies` array (currently `["templates", "hooks"]`)
     - This ensures `nx build cli` triggers `nx build dashboard` first, so the standalone output exists when copy-assets.cjs runs
     - Result: `"implicitDependencies": ["templates", "hooks", "dashboard"]`
  </action>
  <verify>
    <automated>cd /d C:\Development\cli\maxsim && node -e "const pj=require('./packages/cli/project.json');console.log('implicitDeps:', pj.implicitDependencies);const ca=require('fs').readFileSync('./packages/cli/scripts/copy-assets.cjs','utf-8');console.log('has dashboard section:', ca.includes('dashboard'))"</automated>
    copy-assets.cjs has dashboard standalone copy section.
    project.json implicitDependencies includes "dashboard".
  </verify>
  <done>
    copy-assets.cjs copies standalone dashboard (server + .next + node_modules + static + public) to dist/assets/dashboard/.
    project.json implicitDependencies includes dashboard, ensuring NX builds dashboard before CLI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dashboard install-time copy and rework CLI launch command</name>
  <files>
    packages/cli/src/install.ts
    packages/cli/src/cli.ts
  </files>
  <action>
  1. Update `packages/cli/src/install.ts`:

     a) In the `install()` function, after the existing hooks/templates/commands copy sections, add a dashboard copy section:
        - Resolve `dashboardSrc = path.resolve(__dirname, 'assets', 'dashboard')`
        - Check if dashboardSrc exists (it will when the standalone build is included in dist/)
        - If exists, copy recursively to `path.join(installDir, 'dashboard')`
        - Write `dashboard.json` to `path.join(installDir, 'dashboard.json')` (NEXT TO dashboard/ dir, not inside it — per locked decision, this survives overwrites on upgrade)
        - `dashboard.json` content: `{ "projectCwd": process.cwd() }` for local install, or the installDir for global install
        - Use silent install — no special callout, just include in the existing file copy flow (per locked decision)
        - Use ora spinner group like the existing sections, or add to the existing "Installing files" spinner

     b) In the `dashboard` subcommand handler (around line 1773), rework to use the installed standalone build:
        - REPLACE the monorepo-first detection logic with installed-build-first logic:
          1. Check `.claude/dashboard/server.js` in local project (process.cwd() + '.claude/dashboard/server.js')
          2. Check `~/.claude/dashboard/server.js` for global install
          3. If neither exists: auto-install dashboard files from dist/assets/dashboard/ (per locked decision: "No install detected -> auto-install first, then launch")
          4. If server.js found, spawn `node server.js` with:
             - `cwd` set to the dashboard directory (the standalone server.js must run from its directory)
             - `MAXSIM_PROJECT_CWD` set from `dashboard.json` (read projectCwd) or fall back to process.cwd()
             - `NODE_ENV=production`
             - `detached: true, stdio: 'ignore'`
          5. Keep the existing health check and port scan logic for already-running detection (unchanged)
          6. Keep the --stop flag handling (unchanged)
        - REMOVE the monorepo detection fallback (the `findMonorepoRoot()` and tsx runner paths). The installed standalone build IS the primary mechanism now. Dev mode still works via `pnpm run dev` in the monorepo directly.

  2. Update `packages/cli/src/cli.ts`:
     - In the `resolveDashboardServer()` function, add a NEW Strategy 0 (before existing strategies):
       Check for installed standalone server:
       ```typescript
       // Strategy 0: Installed standalone build (production path)
       const localDashboard = path.join(process.cwd(), '.claude', 'dashboard', 'server.js');
       if (fs.existsSync(localDashboard)) return localDashboard;
       const globalDashboard = path.join(os.homedir(), '.claude', 'dashboard', 'server.js');
       if (fs.existsSync(globalDashboard)) return globalDashboard;
       ```
     - Add `import * as os from 'node:os'` at the top of cli.ts if not already imported
     - In `handleDashboard()`, after resolving serverPath, set `cwd` to `path.dirname(serverPath)` when spawning (standalone server must run from its own directory to find .next/)
     - Read `dashboard.json` from `path.join(path.dirname(path.dirname(serverPath)), 'dashboard.json')` (one level up from dashboard/ dir) to get projectCwd for MAXSIM_PROJECT_CWD

  IMPORTANT per locked decisions:
  - Always install dashboard (both global and local) — no opt-in flag
  - Always overwrite on upgrade — no version checks
  - Silent install — no special callout about dashboard size
  - Auto-open browser on launch (already handled by server.ts)
  - If .claude/dashboard/ missing: auto-install first, then launch
  </action>
  <verify>
    <automated>cd /d C:\Development\cli\maxsim && node -e "const i=require('fs').readFileSync('./packages/cli/src/install.ts','utf-8');console.log('has dashboard install:', i.includes('dashboard.json'));console.log('has dashboardSrc:', i.includes('assets') && i.includes('dashboard'));const c=require('fs').readFileSync('./packages/cli/src/cli.ts','utf-8');console.log('has standalone check:', c.includes('.claude/dashboard/server.js') || c.includes('dashboard/server.js'))"</automated>
    install.ts copies dashboard and writes dashboard.json.
    cli.ts resolves installed standalone dashboard server before monorepo fallback.
  </verify>
  <done>
    install.ts copies dist/assets/dashboard/ to .claude/dashboard/ and writes dashboard.json with projectCwd.
    cli.ts handleDashboard() resolves installed standalone server first, spawns with correct cwd and MAXSIM_PROJECT_CWD.
    npx maxsimcli dashboard subcommand uses installed standalone build as primary launch mechanism.
    Auto-install behavior: if .claude/dashboard/ missing, copies from dist/assets/ before launching.
  </done>
</task>

</tasks>

<verification>
1. copy-assets.cjs has Section 4 copying dashboard standalone build
2. project.json implicitDependencies includes "dashboard"
3. install.ts copies dashboard files and writes dashboard.json
4. cli.ts resolves installed standalone server before monorepo fallback
5. dashboard.json written outside dashboard/ dir (survives overwrite)
6. `nx build cli` succeeds (TypeScript compilation, no errors)
</verification>

<success_criteria>
- copy-assets.cjs copies .next/standalone + .next/static + public to dist/assets/dashboard/
- project.json has dashboard in implicitDependencies
- install.ts copies dashboard to .claude/dashboard/ and writes dashboard.json
- cli.ts resolves .claude/dashboard/server.js as primary launch path
- Dashboard launch spawns node with cwd=dashboard dir and MAXSIM_PROJECT_CWD from dashboard.json
- Auto-install if dashboard not found when user runs `npx maxsimcli dashboard`
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-npm-delivery/14-02-SUMMARY.md`
</output>
