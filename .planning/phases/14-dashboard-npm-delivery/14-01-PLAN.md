---
phase: 14-dashboard-npm-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/dashboard/next.config.mjs
  - packages/dashboard/tsdown.config.server.ts
  - packages/dashboard/package.json
  - packages/dashboard/project.json
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03

must_haves:
  truths:
    - "next build with STANDALONE_BUILD=true produces .next/standalone/ directory"
    - "Bundled server.js includes ws, chokidar, detect-port, open inlined and marks next as external"
    - ".next/static/ is copied into .next/standalone/.next/static/ after build"
    - "Dev mode (no env var) still works without standalone — no EPERM errors on Windows"
  artifacts:
    - path: "packages/dashboard/next.config.mjs"
      provides: "Env-var guarded standalone output config with outputFileTracingRoot"
      contains: "STANDALONE_BUILD"
    - path: "packages/dashboard/tsdown.config.server.ts"
      provides: "Server bundling config that inlines ws, chokidar, detect-port, open"
      contains: "external.*next"
    - path: "packages/dashboard/package.json"
      provides: "build:standalone script chaining next build + static copy + server bundle"
      contains: "build:standalone"
    - path: "packages/dashboard/project.json"
      provides: "NX build target using build:standalone for production"
      contains: "build:standalone"
  key_links:
    - from: "packages/dashboard/next.config.mjs"
      to: "packages/dashboard/.next/standalone/"
      via: "output: standalone when STANDALONE_BUILD=true"
      pattern: "STANDALONE_BUILD.*standalone"
    - from: "packages/dashboard/tsdown.config.server.ts"
      to: "packages/dashboard/server.ts"
      via: "entry point for server bundling"
      pattern: "entry.*server"
---

<objective>
Configure the Next.js standalone build pipeline for the dashboard package, including env-var guarded standalone output, server.ts bundling via tsdown (inlining ws/chokidar/detect-port/open, externalizing next), and a build:standalone script that produces a fully self-contained dashboard build.

Purpose: This is the foundation that enables the dashboard to be shipped inside the npm package — without standalone mode, the dashboard requires a full node_modules install which is 100MB+. With standalone, it is 15-30MB with only traced dependencies.

Output: A working `STANDALONE_BUILD=true pnpm --filter @maxsim/dashboard run build:standalone` that produces `.next/standalone/` with bundled server.js and static assets.
</objective>

<execution_context>
@./workflows/execute-plan.md
@./templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-dashboard-npm-delivery/14-CONTEXT.md
@.planning/phases/14-dashboard-npm-delivery/14-RESEARCH.md
@.planning/phases/13-live-project-dashboard/13-02-SUMMARY.md
@.planning/phases/13-live-project-dashboard/13-07-SUMMARY.md
@packages/dashboard/next.config.mjs
@packages/dashboard/server.ts
@packages/dashboard/package.json
@packages/dashboard/project.json
@packages/dashboard/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Next.js standalone output with env-var guard and server bundling config</name>
  <files>
    packages/dashboard/next.config.mjs
    packages/dashboard/tsdown.config.server.ts
  </files>
  <action>
  1. Update `packages/dashboard/next.config.mjs`:
     - Add `import path from 'node:path'` and `import { fileURLToPath } from 'node:url'` at top
     - Compute `__dirname` via `path.dirname(fileURLToPath(import.meta.url))`
     - Replace the commented-out `output: "standalone"` with an env-var guarded conditional:
       ```js
       ...(process.env.STANDALONE_BUILD === 'true' ? {
         output: "standalone",
         outputFileTracingRoot: path.join(__dirname, '../../'),
       } : {})
       ```
     - Keep existing `reactStrictMode: true` and `transpilePackages: ["@maxsim/core"]`

  2. Create `packages/dashboard/tsdown.config.server.ts`:
     - Use `defineConfig` from `tsdown`
     - Entry: `{ server: 'server.ts' }`
     - Format: `'esm'` (consistent with existing server.js build)
     - Platform: `'node'`
     - Target: `'es2022'`
     - External: `['next']` (next is in standalone node_modules)
     - noExternal: `['ws', 'chokidar', 'detect-port', 'open']` (must be inlined since standalone does NOT trace custom server deps)
     - outDir: `.server-build` (same workaround from Phase 13-07 — tsdown cannot use --out-dir . with clean mode)
     - Clean: false (to avoid tsdown deleting the project root)
     - NOTE: The existing `build:server` script in package.json already does tsdown + copy. The new tsdown config file replaces the inline tsdown CLI flags with a config file for clarity.

  IMPORTANT: Do NOT change `server.ts` itself — the existing server.ts with `next({ dev })` pattern works in standalone mode because our bundled server imports `next` from standalone-traced node_modules. The server does NOT need to be rewritten per RESEARCH.md critical detail.
  </action>
  <verify>
    <automated>cd /d C:\Development\cli\maxsim && node -e "const c = await import('./packages/dashboard/next.config.mjs'); const cfg = c.default; console.log('standalone guard present:', JSON.stringify(cfg).includes('standalone') || 'uses env var');" 2>nul || echo "Config loads without error"</automated>
    Verify next.config.mjs imports path/fileURLToPath and has STANDALONE_BUILD conditional.
    Verify tsdown.config.server.ts exists with correct entry, external, noExternal.
  </verify>
  <done>
    next.config.mjs conditionally enables standalone mode when STANDALONE_BUILD=true with outputFileTracingRoot pointing to monorepo root.
    tsdown.config.server.ts defines server bundling with next external and ws/chokidar/detect-port/open inlined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create build:standalone script and update NX build target</name>
  <files>
    packages/dashboard/package.json
    packages/dashboard/project.json
  </files>
  <action>
  1. Update `packages/dashboard/package.json` scripts:
     - Keep existing `dev`, `build:server`, and `start` scripts
     - Add `"build:standalone"` script that chains three steps:
       ```
       "build:standalone": "cross-env STANDALONE_BUILD=true next build && node -e \"require('fs').cpSync('.next/static','.next/standalone/.next/static',{recursive:true})\" && npx tsdown --config tsdown.config.server.ts && node -e \"require('fs').cpSync('.server-build/server.mjs','.next/standalone/server.js');require('fs').rmSync('.server-build',{recursive:true,force:true})\""
       ```
       This does:
       a) `STANDALONE_BUILD=true next build` — produces .next/standalone/
       b) Copy `.next/static/` into `.next/standalone/.next/static/` (Next.js requirement)
       c) Bundle server.ts via tsdown config into .server-build/
       d) Copy bundled server.mjs to .next/standalone/server.js and cleanup .server-build/
     - Add `"cross-env"` to devDependencies if not present (for cross-platform STANDALONE_BUILD=true). Actually, check if cross-env is needed — on CI (Ubuntu) `STANDALONE_BUILD=true` works natively. Since the standalone build only runs in CI, use shell syntax directly:
       ```
       "build:standalone": "STANDALONE_BUILD=true next build && node -e \"require('fs').cpSync('.next/static','.next/standalone/.next/static',{recursive:true})\" && npx tsdown --config tsdown.config.server.ts && node -e \"require('fs').cpSync('.server-build/server.mjs','.next/standalone/server.js');require('fs').rmSync('.server-build',{recursive:true,force:true})\""
       ```
       (CI runs on Ubuntu, so POSIX env syntax is fine. Windows developers use `dev` not `build:standalone`.)
     - Update existing `"build"` script to: `"next build && npm run build:server"` (keep as-is for dev builds)

  2. Update `packages/dashboard/project.json` NX build target:
     - Change the build command from `"pnpm run build"` to `"pnpm run build:standalone"`
     - This ensures `nx build dashboard` produces the standalone output needed by the CLI package
     - Keep `"outputs": ["{projectRoot}/.next"]`
     - Add `"{projectRoot}/.next/standalone"` to outputs array for cache correctness

  3. Also copy `public/` directory into standalone if it exists, by extending the node -e command:
     ```
     node -e "const fs=require('fs');fs.cpSync('.next/static','.next/standalone/.next/static',{recursive:true});if(fs.existsSync('public'))fs.cpSync('public','.next/standalone/public',{recursive:true})"
     ```
  </action>
  <verify>
    <automated>cd /d C:\Development\cli\maxsim && node -e "const pkg=require('./packages/dashboard/package.json');console.log('build:standalone exists:', !!pkg.scripts['build:standalone']);const pj=require('./packages/dashboard/project.json');console.log('NX uses standalone:', JSON.stringify(pj.targets.build.options).includes('standalone'))"</automated>
    package.json has build:standalone script. project.json build target uses build:standalone.
  </verify>
  <done>
    build:standalone script chains: STANDALONE_BUILD=true next build -> static copy -> server bundle -> server copy.
    NX build target uses build:standalone so nx build dashboard produces standalone output.
    project.json outputs include .next/standalone.
  </done>
</task>

</tasks>

<verification>
1. `packages/dashboard/next.config.mjs` has STANDALONE_BUILD env-var guard with outputFileTracingRoot
2. `packages/dashboard/tsdown.config.server.ts` exists with next external, ws/chokidar/detect-port/open noExternal
3. `packages/dashboard/package.json` has build:standalone script
4. `packages/dashboard/project.json` build target uses build:standalone
5. Existing dev workflow (`pnpm run dev`) unaffected — no standalone in dev mode
</verification>

<success_criteria>
- next.config.mjs conditionally enables standalone when STANDALONE_BUILD=true
- tsdown.config.server.ts bundles server.ts with correct externals
- build:standalone script chains all 4 steps (next build, static copy, server bundle, server copy)
- NX build target updated to produce standalone output
- No changes to server.ts source
</success_criteria>

<output>
After completion, create `.planning/phases/14-dashboard-npm-delivery/14-01-SUMMARY.md`
</output>
